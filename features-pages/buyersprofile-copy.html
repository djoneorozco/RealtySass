<!DOCTYPE html><!--  This site was created in Webflow. https://webflow.com  --><!--  Last Published: Tue Feb 10 2026 02:34:24 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="69894da922f2f82b48fab957" data-wf-site="697e270fb126ef5fe6610167" lang="en">
<head>
  <meta charset="utf-8">
  <title>BuyersProfile</title>
  <meta content="BuyersProfile" property="og:title">
  <meta content="BuyersProfile" property="twitter:title">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="Webflow" name="generator">
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/realtysass-a30aee.webflow.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">WebFont.load({  google: {    families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic","PT Serif:400,400italic,700,700italic","Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic","Barlow Condensed:300,400,500,600,700","DM Sans:300,400,500,600,700","Gilda Display:300,400,500,600,700","Inter Tight:300,400,500,600,700"]  }});</script>
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="../images/favicon.svg" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.svg" rel="apple-touch-icon">
</head>
<body class="body-2">
  <div class="w-embed"><!--  ============================================================
 BuyerBrief™ • — EMBED #1 (SHELL CSS)
 ✅ CSS ONLY (Scoped to #bb-shell)
 ✅ FIX: Affordability Zone now uses a simple NEEDLE that reads --bb-afford (%)
 ✅ Keeps SAME IDs used by runtime
============================================================  -->
    <style>
 @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
 /* ============================================================
   //#1 RESET + TOKENS
 ============================================================ */
 #bb-shell, #bb-shell *{
   box-sizing: border-box;
   font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
   letter-spacing: -0.01em;
 }
 #bb-shell{ display:block; width:100%; }
 #bb-shell{
   --bg0:#050712;
   --bg1:#0b0e1a;
   --stroke: rgba(255,255,255,.10);
   --stroke2: rgba(255,255,255,.16);
   --ink:#e9ecff;
   --muted:#a8b0d6;
   --faint: rgba(233,236,255,.55);
   --teal:#8ef3c5;
   --blue:#6aa7ff;
   --ok:#48f2a7;
   --warn:#ffcc66;
   --bad:#ff6b86;
   --shadow0: 0 24px 60px rgba(0,0,0,.75);
   --shadow1: 0 18px 44px rgba(0,0,0,.60);
   --shadow2: 0 10px 22px rgba(0,0,0,.45);
   --r0: 22px;
   --r1: 16px;
   --r2: 12px;
   /* ✅ UPDATE: topbar/footer removed from layout math */
   --topbarH: 0px;
   --pad: 18px;
   --gap: 14px;
   --footerH: 0px;
   /* SecureGlass */
   --cardAlpha: .42;
   --cardBlur: 26px;
   --focus: rgba(142,243,197,.18);
   --focus2: rgba(106,167,255,.14);
 }
 /* ============================================================
   //#2 FULLSCREEN APP SHELL
 ============================================================ */
 #bb-shell .bb-app{
   width: 100vw;
   height: 100vh;
   min-height: 100vh;
   overflow: hidden;
   background:
     radial-gradient(1200px 700px at 18% 10%, rgba(106,167,255,.22), transparent 58%),
     radial-gradient(1000px 650px at 82% 18%, rgba(142,243,197,.16), transparent 60%),
     radial-gradient(1100px 850px at 55% 92%, rgba(142,243,197,.10), transparent 62%),
     radial-gradient(900px 520px at 50% 45%, rgba(255,255,255,.05), transparent 65%),
     linear-gradient(180deg, var(--bg0), var(--bg1));
   position: relative;
 }
 /* soft vignette */
 #bb-shell .bb-app:before{
   content:"";
   position:absolute; inset:-1px;
   background:
     radial-gradient(900px 600px at 50% 0%, rgba(0,0,0,.22), transparent 60%),
     radial-gradient(900px 700px at 50% 100%, rgba(0,0,0,.55), transparent 62%),
     linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.44));
   pointer-events:none;
   opacity:.85;
 }
 /* subtle grain (CSS-only) */
 #bb-shell .bb-app:after{
   content:"";
   position:absolute; inset:0;
   background-image:
     repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0, rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 6px);
   mix-blend-mode: overlay;
   opacity:.10;
   pointer-events:none;
 }
 #bb-shell .bb-frame{
   width: 100%;
   height: 100%;
   border-radius: 0;
   border: 0;
   box-shadow: none;
   background:
     linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
   position: relative;
   overflow: hidden;
 }
 #bb-shell .bb-frame:before{
   content:"";
   position:absolute; inset:0;
   background:
     radial-gradient(1400px 620px at 28% 0%, rgba(255,255,255,.08), transparent 60%),
     radial-gradient(1400px 720px at 72% 0%, rgba(255,255,255,.06), transparent 62%);
   pointer-events:none;
   opacity: .85;
 }
 /* ============================================================
   //#3 TOP BAR (REMOVED VISUALLY)
 ============================================================ */
 #bb-shell .bb-topbar{
   display:none !important; /* ✅ Removed */
 }
 /* Ghost title for runtime safety (keeps #bb-app-title alive) */
 #bb-shell .bb-topbar-ghost{
   position:absolute;
   width:1px; height:1px;
   overflow:hidden;
   clip: rect(0 0 0 0);
   clip-path: inset(50%);
   white-space: nowrap;
   opacity:0;
   pointer-events:none;
 }
 /* ============================================================
   //#4 BODY LAYOUT
 ============================================================ */
 #bb-shell .bb-body{
   position: relative;
   z-index: 2;
   /* ✅ UPDATE: no topbar now */
   height: 100vh;
   padding: var(--pad);
   display: grid;
   /* ✅ UPDATE: remove footer row */
   grid-template-rows: auto 1fr auto;
   gap: var(--gap);
   background:
     linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.24));
   overflow: hidden;
   min-height: 0;
 }
 #bb-shell .bb-row-head{
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 14px;
   min-height: 66px;
   padding: 2px 2px 0;
 }
 #bb-shell .bb-buyer{
   display:flex;
   align-items:center;
   gap: 12px;
   min-width: 0;
 }
 #bb-shell .bb-avatar{
   width: 44px; height: 44px;
   border-radius: 999px;
   background:
     radial-gradient(circle at 35% 30%, rgba(255,255,255,.28), rgba(255,255,255,.04) 60%),
     linear-gradient(180deg, rgba(142,243,197,.12), rgba(106,167,255,.10));
   border: 1px solid rgba(255,255,255,.18);
   box-shadow: 0 16px 30px rgba(0,0,0,.50);
   overflow:hidden;
   flex: 0 0 auto;
   position: relative;
 }
 /* glossy rim */
 #bb-shell .bb-avatar:after{
   content:"";
   position:absolute; inset:-2px;
   border-radius: 999px;
   background: conic-gradient(from 180deg, rgba(142,243,197,.35), rgba(106,167,255,.25), rgba(255,255,255,.10), rgba(142,243,197,.30));
   filter: blur(10px);
   opacity:.35;
   pointer-events:none;
 }
 #bb-shell .bb-buyer-lines{
   min-width: 0;
   display:flex;
   flex-direction:column;
   gap: 2px;
 }
 #bb-shell .bb-buyer-name{
   color: var(--ink);
   font-weight: 900;
   font-size: 16px;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
 }
 #bb-shell .bb-buyer-sub{
   color: rgba(233,236,255,.62);
   font-size: 12px;
   font-weight: 700;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
 }
 #bb-shell .bb-chips{
   display:flex;
   align-items:center;
   gap: 10px;
   flex-wrap: wrap;
   justify-content:flex-end;
 }
 #bb-shell .chip{
   display:inline-flex;
   align-items:center;
   gap: 8px;
   padding: 9px 12px;
   border-radius: 999px;
   border: 1px solid rgba(255,255,255,.12);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   box-shadow:
     0 0 0 1px rgba(255,255,255,.05),
     var(--shadow2);
   color: rgba(233,236,255,.86);
   font-size: 12px;
   font-weight: 800;
   white-space: nowrap;
   position: relative;
   overflow: hidden;
 }
 #bb-shell .chip:before{
   content:"";
   position:absolute; inset:0;
   background:
     radial-gradient(700px 120px at 20% 0%, rgba(255,255,255,.10), transparent 55%),
     radial-gradient(520px 120px at 80% 0%, rgba(255,255,255,.06), transparent 58%);
   opacity:.55;
   pointer-events:none;
 }
 #bb-shell .dot{
   width: 9px; height: 9px;
   border-radius: 999px;
   background: rgba(255,255,255,.25);
   box-shadow: 0 0 0 3px rgba(255,255,255,.06);
   flex: 0 0 auto;
 }
 #bb-shell .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(72,242,167,.12); }
 #bb-shell .dot.blue{ background: var(--blue); box-shadow: 0 0 0 3px rgba(106,167,255,.12); }
 #bb-shell .dot.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(255,204,102,.12); }
 #bb-shell .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 3px rgba(255,107,134,.12); }
 #bb-shell .chip.ok{
   border-color: rgba(72,242,167,.22);
   background: rgba(12,14,25,.55);
   color: rgba(233,236,255,.92);
 }
 #bb-shell .chip.warn{
   border-color: rgba(255,204,102,.22);
   background: rgba(12,14,25,.55);
   color: rgba(233,236,255,.92);
 }
 #bb-shell .chip.bad{
   border-color: rgba(255,107,134,.22);
   background: rgba(12,14,25,.55);
   color: rgba(233,236,255,.92);
 }
 /* ============================================================
   //#5 MAIN TWO-COLUMN LAYOUT
 ============================================================ */
 #bb-shell .bb-grid{
   display:grid;
   grid-template-columns: 1.65fr 1fr;
   gap: var(--gap);
   align-items: stretch;
   overflow: hidden;
   min-height: 0;
 }
 /* SecureGlass panel with gradient stroke + sheen */
 #bb-shell .panel{
   border-radius: var(--r0);
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(16,20,38,var(--cardAlpha));
   backdrop-filter: blur(var(--cardBlur)) saturate(165%);
   -webkit-backdrop-filter: blur(var(--cardBlur)) saturate(165%);
   box-shadow: var(--shadow1);
   overflow:hidden;
   min-height: 0;
   position: relative;
 }
 #bb-shell .panel:before{
   content:"";
   position:absolute; inset:0;
   background:
     radial-gradient(1100px 360px at 18% 0%, rgba(255,255,255,.12), transparent 58%),
     radial-gradient(900px 320px at 82% 0%, rgba(255,255,255,.08), transparent 62%),
     radial-gradient(900px 540px at 30% 100%, rgba(142,243,197,.06), transparent 60%),
     radial-gradient(900px 540px at 70% 100%, rgba(106,167,255,.05), transparent 62%);
   opacity:.75;
   pointer-events:none;
 }
 #bb-shell .panel:after{
   content:"";
   position:absolute; inset:0;
   border-radius: inherit;
   padding: 1px;
   background: linear-gradient(135deg, rgba(142,243,197,.22), rgba(106,167,255,.14), rgba(255,255,255,.10));
   -webkit-mask:
     linear-gradient(#000 0 0) content-box,
     linear-gradient(#000 0 0);
   -webkit-mask-composite: xor;
   mask-composite: exclude;
   opacity:.85;
   pointer-events:none;
 }
 #bb-shell .panel-inner{
   padding: 14px;
   height: 100%;
   min-height: 0;
   display: flex;
   flex-direction: column;
   overflow: hidden;
   position: relative;
   z-index: 1;
 }
 #bb-shell .panel-h{
   display:flex;
   align-items:center;
   justify-content:space-between;
   margin-bottom: 10px;
 }
 #bb-shell .panel-title{
   color: rgba(233,236,255,.92);
   font-weight: 950;
   font-size: 13px;
   letter-spacing: .02em;
   text-transform: uppercase;
 }
 #bb-shell .subtle{
   color: rgba(233,236,255,.55);
   font-size: 11px;
   font-weight: 800;
 }
 /* ============================================================
   //#6 READINESS OVERVIEW — Screenshot Concept
   ✅ Keeps IDs: #bb-mini-afford, #bb-mini-fin, #bb-mini-debt
 ============================================================ */
 #bb-shell .ro-wrap{
   border-radius: 18px;
   border: 1px solid rgba(142,243,197,.30);
   background:
     radial-gradient(1200px 420px at 20% 0%, rgba(142,243,197,.10), transparent 62%),
     radial-gradient(900px 420px at 80% 0%, rgba(106,167,255,.08), transparent 64%),
     rgba(12,14,25,.55);
   box-shadow:
     0 0 0 1px rgba(142,243,197,.08),
     0 24px 60px rgba(0,0,0,.65);
   overflow: hidden;
   position: relative;
 }
 #bb-shell .ro-wrap:before{
   content:"";
   position:absolute; inset:-2px;
   background:
     radial-gradient(900px 220px at 50% 0%, rgba(255,255,255,.10), transparent 58%),
     radial-gradient(1200px 700px at 50% 110%, rgba(0,0,0,.55), transparent 62%);
   opacity:.75;
   pointer-events:none;
 }
 #bb-shell .ro-inner{
   position: relative;
   z-index: 1;
   padding: 14px;
 }
 #bb-shell .ro-grid{
   display:grid;
   grid-template-columns: 1.15fr .9fr .9fr;
   gap: 12px;
 }
 #bb-shell .ro-card{
   border-radius: 16px;
   border: 1px solid rgba(255,255,255,.10);
   background:
     radial-gradient(700px 200px at 20% 0%, rgba(255,255,255,.10), transparent 62%),
     rgba(0,0,0,.24);
   backdrop-filter: blur(16px) saturate(160%);
   -webkit-backdrop-filter: blur(16px) saturate(160%);
   box-shadow: 0 18px 42px rgba(0,0,0,.55);
   overflow: hidden;
   position: relative;
   min-height: 150px;
 }
 #bb-shell .ro-card:after{
   content:"";
   position:absolute; inset:0;
   border-radius: inherit;
   padding: 1px;
   background: linear-gradient(135deg, rgba(142,243,197,.22), rgba(106,167,255,.14), rgba(255,255,255,.08));
   -webkit-mask:
     linear-gradient(#000 0 0) content-box,
     linear-gradient(#000 0 0);
   -webkit-mask-composite: xor;
   mask-composite: exclude;
   opacity:.85;
   pointer-events:none;
 }
 #bb-shell .ro-card.ro-gaugeCard{
   border-color: rgba(142,243,197,.22);
   background:
     radial-gradient(820px 260px at 18% 0%, rgba(142,243,197,.14), transparent 62%),
     radial-gradient(820px 260px at 82% 0%, rgba(106,167,255,.10), transparent 64%),
     rgba(0,0,0,.22);
 }
 #bb-shell .ro-head{
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 10px;
   padding: 12px 12px 0;
 }
 #bb-shell .ro-title{
   display:flex;
   align-items:center;
   gap: 10px;
   color: rgba(233,236,255,.92);
   font-weight: 950;
   font-size: 13px;
   letter-spacing: .02em;
   text-transform: uppercase;
 }
 #bb-shell .ro-badge{
   width: 30px; height: 30px;
   border-radius: 12px;
   border: 1px solid rgba(142,243,197,.22);
   background: rgba(12,14,25,.55);
   box-shadow: 0 14px 26px rgba(0,0,0,.45);
   display:flex;
   align-items:center;
   justify-content:center;
   color: rgba(142,243,197,.95);
   flex: 0 0 auto;
 }
 #bb-shell .ro-badge svg{ width: 16px; height: 16px; fill: currentColor; }
 #bb-shell .ro-body{
   padding: 10px 12px 12px;
   display:flex;
   gap: 14px;
   align-items:center;
 }
 #bb-shell .ro-gauge{
   width: 150px;
   height: 110px;
   position: relative;
   flex: 0 0 auto;
 }
 #bb-shell .ro-gauge svg{ width:100%; height:100%; display:block; }
 /* ============================================================
   ✅ FIX: AFFORDABILITY NEEDLE (reads --bb-afford)
   - 0%   => -90deg (far left)
   - 100% => +90deg (far right)
   Runtime can update:
   document.querySelector("#bb-mini-afford").style.setProperty("--bb-afford", pct);
 ============================================================ */
 /* default (shell) */
 #bb-shell #bb-mini-afford{
   --bb-afford: 80; /* fallback */
   --bb-afford-angle: calc(-90deg + (var(--bb-afford) * 1.8deg));
 }
 /* remove old check bubble (if any) */
 #bb-shell #bb-mini-afford .ro-check{ display:none !important; }
 /* needle */
 #bb-shell .ro-needle{
   position:absolute;
   left:50%;
   bottom: 14px;             /* base sits on arc baseline */
   width: 3px;
   height: 66px;             /* needle length */
   transform: translateX(-50%) rotate(var(--bb-afford-angle));
   transform-origin: 50% 100%;
   border-radius: 999px;
   background: linear-gradient(180deg, rgba(233,236,255,.95), rgba(142,243,197,.75));
   box-shadow:
     0 10px 22px rgba(0,0,0,.45),
     0 0 0 1px rgba(255,255,255,.10),
     0 0 18px rgba(142,243,197,.20);
   pointer-events:none;
   z-index: 3;
 }
 /* needle tip glow */
 #bb-shell .ro-needle:before{
   content:"";
   position:absolute;
   top:-10px;
   left:50%;
   transform: translateX(-50%);
   width: 14px;
   height: 14px;
   border-radius: 999px;
   background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.70), rgba(106,167,255,.35) 55%, rgba(142,243,197,.10) 72%, rgba(0,0,0,0) 74%);
   filter: blur(.2px);
   opacity:.90;
 }
 /* base hub */
 #bb-shell .ro-needleHub{
   position:absolute;
   left:50%;
   bottom: 6px;
   transform: translateX(-50%);
   width: 20px;
   height: 20px;
   border-radius: 999px;
   background:
     radial-gradient(circle at 35% 30%, rgba(255,255,255,.30), rgba(0,0,0,.20)),
     linear-gradient(180deg, rgba(142,243,197,.18), rgba(106,167,255,.10));
   border: 1px solid rgba(255,255,255,.16);
   box-shadow:
     0 18px 30px rgba(0,0,0,.55),
     0 0 0 4px rgba(142,243,197,.08);
   pointer-events:none;
   z-index: 4;
 }
 /* optional: small tick dots across the arc baseline */
 #bb-shell .ro-gaugeTicks{
   position:absolute;
   left: 16px;
   right: 16px;
   bottom: 10px;
   height: 8px;
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 6px;
   pointer-events:none;
   z-index: 2;
   opacity:.75;
 }
 #bb-shell .ro-gaugeTicks i{
   display:block;
   width: 2px;
   height: 8px;
   border-radius: 999px;
   background: rgba(142,243,197,.42);
 }
 #bb-shell .ro-gaugeTicks i.major{
   height: 10px;
   background: rgba(142,243,197,.70);
   box-shadow: 0 0 0 2px rgba(142,243,197,.08);
 }
 #bb-shell .ro-score{
   display:flex;
   flex-direction:column;
   gap: 4px;
   min-width: 0;
 }
 #bb-shell .ro-scoreBig{
   font-size: 52px;
   font-weight: 950;
   letter-spacing: -0.03em;
   color: rgba(142,243,197,.92);
   line-height: 1;
 }
 #bb-shell .ro-scoreBig .pct{
   font-size: 18px;
   font-weight: 900;
   color: rgba(233,236,255,.70);
   margin-left: 4px;
 }
 #bb-shell .ro-scoreText{
   color: rgba(142,243,197,.88);
   font-weight: 950;
   text-transform: uppercase;
   letter-spacing: .08em;
   font-size: 12px;
 }
 #bb-shell .ro-scoreText b{
   color: rgba(233,236,255,.90);
   font-weight: 950;
 }
 #bb-shell .ro-metricBody{
   padding: 10px 12px 12px;
 }
 #bb-shell .ro-metricTop{
   display:flex;
   align-items:center;
   gap: 10px;
   margin-bottom: 8px;
 }
 #bb-shell .ro-iconBox{
   width: 30px; height: 30px;
   border-radius: 12px;
   border: 1px solid rgba(255,255,255,.14);
   background: rgba(12,14,25,.55);
   display:flex;
   align-items:center;
   justify-content:center;
   box-shadow: 0 14px 26px rgba(0,0,0,.45);
 }
 #bb-shell .ro-iconBox svg{ width: 16px; height: 16px; fill: currentColor; }
 #bb-shell .ro-iconBox.blue{ color: rgba(106,167,255,.95); border-color: rgba(106,167,255,.22); }
 #bb-shell .ro-iconBox.gold{ color: rgba(255,204,102,.95); border-color: rgba(255,204,102,.22); }
 #bb-shell .ro-metricTitle{
   color: rgba(233,236,255,.92);
   font-weight: 950;
   font-size: 14px;
 }
 #bb-shell .ro-metricSub{
   color: rgba(233,236,255,.70);
   font-weight: 850;
   font-size: 12px;
   margin-top: 2px;
 }
 #bb-shell .ro-bar{
   height: 10px;
   border-radius: 999px;
   background: rgba(255,255,255,.10);
   overflow:hidden;
   border: 1px solid rgba(255,255,255,.10);
   box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
   margin: 10px 0 8px;
 }
 #bb-shell .ro-bar > i{
   display:block;
   height:100%;
   width: 80%;
   border-radius: 999px;
   background: linear-gradient(90deg, rgba(142,243,197,.95), rgba(106,167,255,.88));
 }
 #bb-shell .ro-bar.gold > i{
   background: linear-gradient(90deg, rgba(255,204,102,.95), rgba(255,175,60,.88));
 }
 #bb-shell .ro-percent{
   display:flex;
   align-items:baseline;
   justify-content:flex-end;
   gap: 6px;
   color: rgba(233,236,255,.90);
   font-weight: 950;
 }
 #bb-shell .ro-percent b{
   font-size: 44px;
   letter-spacing: -0.02em;
 }
 #bb-shell .ro-percent span{
   font-size: 14px;
   color: rgba(233,236,255,.65);
   font-weight: 900;
 }
 /* ============================================================
   //#6B READINESS VISUAL UPGRADE (REQUIRED FOR 2C v0.2.0)
   - Reacts to: .bb-tone-ok/.bb-tone-warn/.bb-tone-bad + data-tone
 ============================================================ */
 #bb-shell .bb-tone-ok{
   border-color: rgba(72,242,167,.22) !important;
   background:
     radial-gradient(900px 220px at 20% 0%, rgba(72,242,167,.10), transparent 60%),
     rgba(12,14,25,.55) !important;
   box-shadow:
     0 0 0 1px rgba(72,242,167,.08),
     0 22px 42px rgba(0,0,0,.60) !important;
 }
 #bb-shell .bb-tone-ok:after{ background: linear-gradient(180deg, rgba(72,242,167,.95), rgba(106,167,255,.70)); }
 #bb-shell .bb-tone-warn{
   border-color: rgba(255,204,102,.22) !important;
   background:
     radial-gradient(900px 220px at 20% 0%, rgba(255,204,102,.10), transparent 60%),
     rgba(12,14,25,.55) !important;
   box-shadow:
     0 0 0 1px rgba(255,204,102,.08),
     0 22px 42px rgba(0,0,0,.60) !important;
 }
 #bb-shell .bb-tone-warn:after{ background: linear-gradient(180deg, rgba(255,204,102,.95), rgba(255,107,134,.55)); }
 #bb-shell .bb-tone-bad{
   border-color: rgba(255,107,134,.22) !important;
   background:
     radial-gradient(900px 220px at 20% 0%, rgba(255,107,134,.10), transparent 60%),
     rgba(12,14,25,.55) !important;
   box-shadow:
     0 0 0 1px rgba(255,107,134,.08),
     0 22px 42px rgba(0,0,0,.60) !important;
 }
 #bb-shell .bb-tone-bad:after{ background: linear-gradient(180deg, rgba(255,107,134,.95), rgba(106,167,255,.45)); }
 #bb-shell .bb-tone-neutral{
   border-color: rgba(255,255,255,.12) !important;
 }
 #bb-shell #bb-chip-status.warn .dot{ background: var(--warn); box-shadow: 0 0 0 3px rgba(255,204,102,.12); }
 #bb-shell #bb-chip-status.bad  .dot{ background: var(--bad);  box-shadow: 0 0 0 3px rgba(255,107,134,.12); }
 #bb-shell #bb-chip-status[data-tone="neutral"]{
   border-color: rgba(255,255,255,.14);
   background: rgba(12,14,25,.55);
 }
 /* ============================================================
   //#7 BUYER PREFERENCES — Screenshot Concept
   ✅ Keeps your SAME IDs
 ============================================================ */
 #bb-shell .pref-grid{
   margin-top: 12px;
   display:grid;
   grid-template-columns: 1fr 1fr;
   gap: 12px;
 }
 #bb-shell .pref{
   border-radius: 16px;
   border: 1px solid rgba(255,255,255,.12);
   background:
     radial-gradient(700px 170px at 20% 0%, rgba(255,255,255,.08), transparent 62%),
     rgba(0,0,0,.22);
   backdrop-filter: blur(16px) saturate(160%);
   -webkit-backdrop-filter: blur(16px) saturate(160%);
   box-shadow: 0 18px 42px rgba(0,0,0,.55);
   padding: 14px;
   min-height: 78px;
   display:flex;
   align-items:center;
   gap: 12px;
   position: relative;
   overflow:hidden;
 }
 #bb-shell .pref:after{
   content:"";
   position:absolute; inset:0;
   border-radius: inherit;
   padding: 1px;
   background: linear-gradient(135deg, rgba(142,243,197,.18), rgba(106,167,255,.12), rgba(255,255,255,.06));
   -webkit-mask:
     linear-gradient(#000 0 0) content-box,
     linear-gradient(#000 0 0);
   -webkit-mask-composite: xor;
   mask-composite: exclude;
   opacity:.85;
   pointer-events:none;
 }
 #bb-shell .pref-ico{
   width: 42px; height: 42px;
   border-radius: 14px;
   border: 1px solid rgba(255,255,255,.14);
   background:
     radial-gradient(circle at 35% 30%, rgba(255,255,255,.20), rgba(0,0,0,.22)),
     rgba(12,14,25,.55);
   box-shadow: 0 18px 34px rgba(0,0,0,.55);
   display:flex;
   align-items:center;
   justify-content:center;
   flex: 0 0 auto;
 }
 #bb-shell .pref-ico svg{ width: 18px; height: 18px; fill: currentColor; }
 #bb-shell .pref-ico.tone-mint{ color: rgba(142,243,197,.95); border-color: rgba(142,243,197,.22); }
 #bb-shell .pref-ico.tone-blue{ color: rgba(106,167,255,.95); border-color: rgba(106,167,255,.22); }
 #bb-shell .pref-ico.tone-gold{ color: rgba(255,204,102,.95); border-color: rgba(255,204,102,.22); }
 #bb-shell .pref-ico.tone-pink{ color: rgba(255,107,134,.95); border-color: rgba(255,107,134,.22); }
 #bb-shell .pref-lines{ display:flex; flex-direction:column; gap: 2px; min-width:0; position: relative; z-index: 1; }
 #bb-shell .pref-k{ color: rgba(233,236,255,.70); font-weight: 950; font-size: 11px; letter-spacing:.10em; text-transform: uppercase; }
 #bb-shell .pref-v{
   color: rgba(233,236,255,.92);
   font-weight: 900;
   font-size: 14px;
   white-space: nowrap;
   overflow:hidden;
   text-overflow: ellipsis;
 }
 /* ============================================================
   //#8 ELENA PANEL (unchanged)
 ============================================================ */
 #bb-shell .elena-head{
   display:flex;
   align-items:center;
   gap: 10px;
   margin-bottom: 10px;
 }
 #bb-shell .elena-ring{
   width: 18px; height: 18px;
   border-radius: 999px;
   border: 2px solid rgba(142,243,197,.75);
   box-shadow: 0 0 0 4px rgba(142,243,197,.10);
   position: relative;
 }
 #bb-shell .elena-ring:after{
   content:"";
   position:absolute; inset: 3px;
   border-radius: 999px;
   background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.30), rgba(142,243,197,.12));
 }
 #bb-shell .elena-title{
   color: rgba(233,236,255,.92);
   font-weight: 950;
   font-size: 13px;
   letter-spacing: .02em;
   text-transform: uppercase;
 }
 #bb-shell .elena-mode{
   border-radius: var(--r1);
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(var(--cardBlur)) saturate(165%);
   -webkit-backdrop-filter: blur(var(--cardBlur)) saturate(165%);
   padding: 12px;
   box-shadow:
     0 0 0 1px rgba(255,255,255,.05),
     var(--shadow2);
   min-height: 270px;
   position: relative;
   overflow:hidden;
 }
 #bb-shell .elena-mode:before{
   content:"";
   position:absolute; inset:0;
   background:
     radial-gradient(900px 480px at 30% 0%, rgba(142,243,197,.10), transparent 60%),
     radial-gradient(900px 480px at 70% 0%, rgba(106,167,255,.08), transparent 62%),
     radial-gradient(900px 520px at 50% 100%, rgba(255,255,255,.06), transparent 62%);
   opacity:.75;
   pointer-events:none;
 }
 #bb-shell .elena-copy{
   color: rgba(233,236,255,.82);
   font-size: 13px;
   font-weight: 700;
   line-height: 1.6;
   white-space: pre-line;
   position: relative;
   z-index: 1;
 }
 /* ============================================================
   //#9 TIMELINE (unchanged)
 ============================================================ */
 #bb-shell .timeline-wrap{
   min-height: 0;
   display:flex;
   flex-direction:column;
   gap: 10px;
 }
 #bb-shell .timeline-head{
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 10px;
   padding: 0 6px;
 }
 #bb-shell .timeline-title{
   color: rgba(233,236,255,.88);
   font-weight: 950;
   font-size: 13px;
   letter-spacing: .02em;
   text-transform: uppercase;
 }
 #bb-shell .timeline-hint{
   color: rgba(233,236,255,.58);
   font-weight: 850;
   font-size: 11px;
   white-space: nowrap;
 }
 #bb-shell .timeline{
   border-radius: var(--r0);
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(var(--cardBlur)) saturate(165%);
   -webkit-backdrop-filter: blur(var(--cardBlur)) saturate(165%);
   box-shadow: var(--shadow1);
   padding: 12px;
   overflow: hidden;
   position: relative;
 }
 #bb-shell .timeline:before{
   content:"";
   position:absolute; inset:0;
   background:
     radial-gradient(1100px 340px at 18% 0%, rgba(255,255,255,.10), transparent 60%),
     radial-gradient(900px 300px at 82% 0%, rgba(255,255,255,.06), transparent 62%),
     radial-gradient(900px 540px at 30% 100%, rgba(142,243,197,.06), transparent 60%),
     radial-gradient(900px 540px at 70% 100%, rgba(106,167,255,.05), transparent 62%);
   opacity:.75;
   pointer-events:none;
 }
 #bb-shell .t-viewport{
   width: 100%;
   overflow-x: auto;
   overflow-y: hidden;
   padding-bottom: 8px;
   -webkit-overflow-scrolling: touch;
   scrollbar-width: none;
   position: relative;
   z-index: 1;
 }
 #bb-shell .t-viewport::-webkit-scrollbar{ display:none; }
 #bb-shell .t-inner{
   min-width: 1180px;
   position: relative;
   padding: 4px 14px 10px;
 }
 #bb-shell .t-boundary{
   position:absolute;
   top: 8px;
   bottom: 12px;
   width: 3px;
   border-radius: 999px;
   background: rgba(142,243,197,.95);
   box-shadow:
     0 0 0 3px rgba(142,243,197,.10),
     0 18px 40px rgba(0,0,0,.35);
   opacity: .95;
   pointer-events:none;
 }
 #bb-shell .t-boundary.left{ left: 6px; }
 #bb-shell .t-boundary.right{ right: 6px; }
 #bb-shell .t-months{
   display:grid;
   grid-template-columns: repeat(4, 1fr);
   gap: 10px;
   align-items:end;
   margin-bottom: 8px;
   padding: 0 6px;
 }
 #bb-shell .t-month{
   color: rgba(233,236,255,.80);
   font-weight: 950;
   font-size: 11px;
   display:flex;
   justify-content:space-between;
   align-items:center;
   padding: 0 2px;
 }
 #bb-shell .t-month span{
   opacity: .95;
   letter-spacing: .08em;
   text-transform: uppercase;
 }
 #bb-shell .t-weeks{
   height: 16px;
   border-radius: 999px;
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(0,0,0,.18);
   display:flex;
   align-items:center;
   justify-content:space-between;
   padding: 0 10px;
   box-shadow: var(--shadow2);
   margin: 0 6px 10px;
 }
 #bb-shell .tick{
   width: 2px;
   height: 10px;
   border-radius: 999px;
   background: rgba(142,243,197,.55);
   opacity: .9;
 }
 #bb-shell .tick.major{
   height: 12px;
   background: rgba(142,243,197,.78);
   box-shadow: 0 0 0 2px rgba(142,243,197,.10);
 }
 #bb-shell .rail{
   height: 10px;
   border-radius: 999px;
   background: rgba(255,255,255,.10);
   position: relative;
   margin: 2px 6px 10px;
   overflow:hidden;
 }
 #bb-shell .rail .fill{
   position:absolute; inset:0 auto 0 0;
   width: 58%;
   border-radius: 999px;
   background: linear-gradient(90deg, rgba(142,243,197,.88), rgba(106,167,255,.82));
   opacity: .65;
 }
 #bb-shell .nodes{
   position: relative;
   height: 70px;
   display:flex;
   align-items:flex-start;
   justify-content:space-between;
   gap: 10px;
   padding-top: 2px;
   margin: 0 6px;
 }
 #bb-shell .node{
   width: 18%;
   min-width: 130px;
   display:flex;
   flex-direction:column;
   gap: 6px;
   align-items:center;
   text-align:center;
   color: rgba(233,236,255,.78);
   font-weight: 850;
   font-size: 11px;
   user-select:none;
   cursor: pointer;
   padding: 8px 8px 10px;
   border-radius: 16px;
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(12,14,25,.40);
   backdrop-filter: blur(12px) saturate(155%);
   -webkit-backdrop-filter: blur(12px) saturate(155%);
   box-shadow: 0 12px 24px rgba(0,0,0,.34);
   transition: transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
   position: relative;
   overflow:hidden;
 }
 #bb-shell .node:before{
   content:"";
   position:absolute; inset:0;
   background:
     radial-gradient(520px 140px at 20% 0%, rgba(255,255,255,.10), transparent 58%),
     radial-gradient(420px 120px at 80% 0%, rgba(255,255,255,.06), transparent 62%);
   opacity:.55;
   pointer-events:none;
 }
 #bb-shell .node:hover{
   border-color: rgba(142,243,197,.18);
   transform: translateY(-1px);
   box-shadow: 0 16px 30px rgba(0,0,0,.44);
 }
 #bb-shell .node.is-active{
   border-color: rgba(142,243,197,.26);
   background:
     radial-gradient(700px 220px at 50% 0%, rgba(142,243,197,.12), transparent 62%),
     rgba(12,14,25,.46);
   box-shadow:
     0 0 0 1px rgba(142,243,197,.08),
     0 18px 34px rgba(0,0,0,.55);
 }
 #bb-shell .pin{
   width: 10px; height: 10px;
   border-radius: 999px;
   border: 2px solid rgba(255,255,255,.25);
   background: rgba(0,0,0,.25);
   box-shadow: 0 0 0 4px rgba(255,255,255,.06);
   margin-top: -2px;
   position: relative;
   z-index: 1;
 }
 #bb-shell .pin.ok{ border-color: rgba(72,242,167,.70); box-shadow: 0 0 0 4px rgba(72,242,167,.10); }
 #bb-shell .pin.warn{ border-color: rgba(255,204,102,.75); box-shadow: 0 0 0 4px rgba(255,204,102,.10); }
 #bb-shell .node small{
   display:block;
   color: rgba(233,236,255,.58);
   font-weight: 850;
   font-size: 10px;
   margin-top: -2px;
   letter-spacing: .06em;
   text-transform: uppercase;
   position: relative;
   z-index: 1;
 }
 #bb-shell .node-title{ position: relative; z-index: 1; }
 /* ============================================================
   //#10 FOOTER ACTIONS (REMOVED VISUALLY)
 ============================================================ */
 #bb-shell .bb-footer{
   display:none !important; /* ✅ Removed */
 }
 /* Ghost footer for runtime safety (keeps button IDs alive) */
 #bb-shell .bb-footer-ghost{
   position:absolute;
   width:1px; height:1px;
   overflow:hidden;
   clip: rect(0 0 0 0);
   clip-path: inset(50%);
   white-space: nowrap;
   opacity:0;
   pointer-events:none;
 }
 /* ============================================================
   //#11 MORPH + STACKS (unchanged)
 ============================================================ */
 #bb-shell .bb-morph-focus{
   box-shadow:
     0 0 0 1px rgba(142,243,197,.22),
     0 24px 44px rgba(0,0,0,.55);
 }
 #bb-shell .bb-stack{
   display:block;
   min-height: 0;
   height: 100%;
   overflow: hidden;
 }
 #bb-shell .bb-stack > section{
   display:none;
   min-height: 0;
   height: 100%;
 }
 #bb-shell .bb-stack > section.is-on{
   display:flex;
   flex-direction: column;
   min-height: 0;
   height: 100%;
 }
 #bb-shell #bb-left-editor,
 #bb-shell #bb-right-calendar{
   min-height: 0;
   height: 100%;
   display:flex;
   flex-direction: column;
   overflow: hidden;
 }
 #bb-shell .bb-edit-head{
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 10px;
   margin-bottom: 10px;
   flex: 0 0 auto;
 }
 #bb-shell .bb-edit-title{
   color: rgba(233,236,255,.92);
   font-weight: 950;
   font-size: 13px;
   display:flex;
   align-items:center;
   gap: 10px;
   letter-spacing: .02em;
   text-transform: uppercase;
 }
 #bb-shell .bb-pill{
   display:inline-flex;
   align-items:center;
   gap: 8px;
   padding: 6px 10px;
   border-radius: 999px;
   border: 1px solid rgba(255,255,255,.12);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   color: rgba(233,236,255,.78);
   font-weight: 900;
   font-size: 11px;
   white-space: nowrap;
 }
 #bb-shell .bb-x{
   all: unset;
   cursor: pointer;
   width: 32px;
   height: 32px;
   border-radius: 12px;
   display:flex;
   align-items:center;
   justify-content:center;
   border: 1px solid rgba(255,255,255,.12);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   box-shadow: var(--shadow2);
   color: rgba(233,236,255,.76);
   flex: 0 0 auto;
 }
 #bb-shell .bb-x:hover{ border-color: rgba(142,243,197,.20); color: rgba(233,236,255,.92); }
 #bb-shell .bb-form{
   display:flex;
   flex-direction:column;
   gap: 10px;
   min-height: 0;
   overflow-y: auto;
   padding-right: 6px;
   -webkit-overflow-scrolling: touch;
 }
 #bb-shell .bb-form::-webkit-scrollbar,
 #bb-shell .bb-cal-grid::-webkit-scrollbar{
   width: 10px;
 }
 #bb-shell .bb-form::-webkit-scrollbar-thumb,
 #bb-shell .bb-cal-grid::-webkit-scrollbar-thumb{
   background: rgba(255,255,255,.12);
   border-radius: 999px;
   border: 2px solid rgba(0,0,0,.35);
 }
 #bb-shell .bb-form::-webkit-scrollbar-track,
 #bb-shell .bb-cal-grid::-webkit-scrollbar-track{
   background: rgba(0,0,0,.18);
   border-radius: 999px;
 }
 #bb-shell .bb-field{
   display:flex;
   flex-direction:column;
   gap: 6px;
 }
 #bb-shell .bb-label{
   color: rgba(233,236,255,.70);
   font-size: 11px;
   font-weight: 900;
   letter-spacing: .08em;
   text-transform: uppercase;
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 10px;
 }
 #bb-shell .bb-input, #bb-shell .bb-select, #bb-shell .bb-textarea{
   width: 100%;
   border-radius: 12px;
   border: 1px solid rgba(255,255,255,.12);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   color: rgba(233,236,255,.92);
   font-weight: 750;
   font-size: 13px;
   padding: 10px 12px;
   outline: none;
   box-shadow: var(--shadow2);
 }
 #bb-shell .bb-textarea{ min-height: 84px; resize: vertical; }
 #bb-shell .bb-input:focus, #bb-shell .bb-select:focus, #bb-shell .bb-textarea:focus{
   border-color: rgba(142,243,197,.24);
   box-shadow:
     0 0 0 3px rgba(142,243,197,.10),
     var(--shadow2);
 }
 #bb-shell .bb-row2{
   display:grid;
   grid-template-columns: 1fr 1fr;
   gap: 10px;
 }
 #bb-shell .bb-attach{
   border-radius: 12px;
   border: 1px dashed rgba(255,255,255,.18);
   background: rgba(255,255,255,.03);
   padding: 10px 12px;
   color: rgba(233,236,255,.68);
   font-weight: 800;
   font-size: 12px;
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 10px;
 }
 #bb-shell .bb-attach button{
   all: unset;
   cursor: pointer;
   padding: 8px 10px;
   border-radius: 12px;
   border: 1px solid rgba(255,255,255,.14);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   font-weight: 900;
   font-size: 12px;
   color: rgba(233,236,255,.86);
   box-shadow: var(--shadow2);
   white-space: nowrap;
 }
 #bb-shell .bb-attach button:hover{
   border-color: rgba(142,243,197,.22);
   color: rgba(233,236,255,.96);
 }
 #bb-shell .bb-actions{
   display:flex;
   gap: 10px;
   justify-content:flex-end;
   margin-top: 4px;
   padding-bottom: 6px;
 }
 #bb-shell .bb-action{
   all: unset;
   cursor: pointer;
   padding: 10px 12px;
   border-radius: 999px;
   font-weight: 950;
   font-size: 12px;
   border: 1px solid rgba(255,255,255,.14);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   color: rgba(233,236,255,.86);
   box-shadow: var(--shadow2);
   user-select:none;
   white-space: nowrap;
 }
 #bb-shell .bb-action.primary{
   border-color: rgba(142,243,197,.26);
   background: radial-gradient(circle at 30% 20%, rgba(142,243,197,.35), rgba(106,167,255,.18) 60%), rgba(12,14,25,.55);
   color: rgba(233,236,255,.95);
 }
 #bb-shell .bb-action:hover{ border-color: rgba(142,243,197,.20); }
 #bb-shell .bb-cal-grid{
   display:grid;
   grid-template-columns: 1fr;
   gap: 10px;
   min-height: 0;
   overflow-y: auto;
   padding-right: 6px;
   -webkit-overflow-scrolling: touch;
 }
 #bb-shell .bb-cal-month{
   display:flex;
   align-items:center;
   justify-content:space-between;
   gap: 10px;
   padding: 10px 12px;
   border-radius: 14px;
   border: 1px solid rgba(255,255,255,.12);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   box-shadow: var(--shadow2);
 }
 #bb-shell .bb-cal-month strong{
   color: rgba(233,236,255,.90);
   font-weight: 950;
   font-size: 12px;
   letter-spacing: .02em;
   text-transform: uppercase;
 }
 #bb-shell .bb-cal-nav{
   display:flex;
   gap: 8px;
 }
 #bb-shell .bb-cal-nav button{
   all: unset;
   cursor: pointer;
   width: 32px;
   height: 32px;
   border-radius: 12px;
   border: 1px solid rgba(255,255,255,.12);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   box-shadow: var(--shadow2);
   color: rgba(233,236,255,.78);
   display:flex;
   align-items:center;
   justify-content:center;
   font-weight: 950;
 }
 #bb-shell .bb-cal-nav button:hover{ border-color: rgba(142,243,197,.22); color: rgba(233,236,255,.95); }
 #bb-shell .bb-cal-days{
   display:grid;
   grid-template-columns: repeat(7, 1fr);
   gap: 8px;
   padding: 10px;
   border-radius: 16px;
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(12,14,25,.45);
   backdrop-filter: blur(14px) saturate(160%);
   -webkit-backdrop-filter: blur(14px) saturate(160%);
   box-shadow: var(--shadow2);
 }
 #bb-shell .bb-cal-dow{
   text-align:center;
   color: rgba(233,236,255,.58);
   font-weight: 900;
   font-size: 11px;
   padding-bottom: 4px;
   text-transform: uppercase;
   letter-spacing: .08em;
 }
 #bb-shell .bb-day{
   width: 100%;
   aspect-ratio: 7 / 5;
   border-radius: 14px;
   border: 1px solid rgba(255,255,255,.10);
   background: rgba(12,14,25,.55);
   backdrop-filter: blur(12px) saturate(155%);
   -webkit-backdrop-filter: blur(12px) saturate(155%);
   box-shadow: 0 12px 20px rgba(0,0,0,.28);
   display:flex;
   align-items:center;
   justify-content:center;
   color: rgba(233,236,255,.84);
   font-weight: 900;
   font-size: 12px;
   user-select:none;
   cursor:pointer;
 }
 #bb-shell .bb-day.is-off{ opacity: .35; cursor: default; }
 #bb-shell .bb-day.is-on{
   border-color: rgba(142,243,197,.24);
   background:
     radial-gradient(circle at 35% 30%, rgba(255,255,255,.14), rgba(0,0,0,.0) 55%),
     radial-gradient(circle at 25% 20%, rgba(142,243,197,.22), rgba(106,167,255,.12) 55%),
     rgba(12,14,25,.55);
   color: rgba(233,236,255,.96);
   box-shadow:
     0 0 0 3px rgba(142,243,197,.10),
     0 18px 28px rgba(0,0,0,.35);
 }
 #bb-shell .bb-user-row{
   display:grid;
   grid-template-columns: 1fr;
   gap: 10px;
 }
 #bb-shell .bb-time-row{
   display:grid;
   grid-template-columns: 1fr 1fr;
   gap: 10px;
 }
 #bb-shell .bb-helper{
   color: rgba(233,236,255,.68);
   font-weight: 750;
   font-size: 12px;
   line-height: 1.45;
 }
 /* ============================================================
   //#12 RESPONSIVE
 ============================================================ */
 @media (max-width: 980px){
   #bb-shell .bb-body{ grid-template-rows: auto 1fr auto; }
   #bb-shell .bb-grid{ grid-template-columns: 1fr; }
   #bb-shell .pref-grid{ grid-template-columns: 1fr; }
   #bb-shell .bb-row-head{ flex-direction: column; align-items:flex-start; }
   #bb-shell .bb-chips{ justify-content:flex-start; }
   #bb-shell .t-inner{ min-width: 980px; }
   #bb-shell .bb-row2, #bb-shell .bb-time-row{ grid-template-columns: 1fr; }
   /* Readiness cards stack on mobile */
   #bb-shell .ro-grid{ grid-template-columns: 1fr; }
 }
</style>
  </div>
  <div class="code-embed-29 w-embed"><!--  ============================================================
 BuyerBrief™ • 2A INTERACTION PROTOTYPE — EMBED #2 (SHELL HTML)
 ✅ HTML + MARKUP ONLY
 ✅ Updated Readiness Overview + Buyer Preferences to match screenshot concept
 ✅ Keeps SAME IDs used by runtime
 ✅ UPDATE: Affordability Zone now uses NEEDLE/POINTER (replaces checkmark)
============================================================  -->
    <div id="bb-shell" style="all: initial;">
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
      <div class="bb-app">
        <div class="bb-frame">
          <!--  ✅ TOP BAR REMOVED (ghost kept for runtime safety)  -->
          <div class="bb-topbar-ghost" aria-hidden="true">
            <span id="bb-app-title">Buyer Intelligence Profile</span>
          </div>
          <!--  BODY  -->
          <div class="bb-body">
            <!--  HEADER ROW  -->
            <div class="bb-row-head">
              <div class="bb-buyer">
                <div class="bb-avatar" id="bb-avatar"></div>
                <div class="bb-buyer-lines">
                  <div class="bb-buyer-name" id="bb-buyer-name">PCS Buyer #4821 <span style="font-weight:700; color:rgba(233,236,255,.60);">(Army O-3, Family)</span></div>
                  <div class="bb-buyer-sub" id="bb-buyer-sub">BuyerBrief™ Snapshot • Timeline-first workspace</div>
                </div>
              </div>
              <div class="bb-chips">
                <div class="chip ok" id="bb-chip-status">
                  <span class="dot ok"></span>
                  <span id="bb-status-text">GREEN • READY</span>
                </div>
                <div class="chip" id="bb-chip-window">
                  <span class="dot blue"></span>
                  <span>PCS Window: <strong style="font-weight:900;">30–60 Days</strong></span>
                </div>
                <div class="chip" id="bb-chip-range">
                  <span class="dot"></span>
                  <span>Target Range: <strong style="font-weight:900;">$420K - $480K</strong></span>
                </div>
              </div>
            </div>
            <!--  MAIN GRID  -->
            <div class="bb-grid">
              <!--  LEFT COLUMN  -->
              <div class="panel" id="bb-left">
                <div class="panel-inner" id="bb-readiness">
                  <div class="bb-stack" id="bb-left-stack">
                    <!--  LEFT: BRIEF MODE  -->
                    <section class="is-on" id="bb-left-brief">
                      <div class="panel-h">
                        <div class="panel-title">Readiness Overview</div>
                        <div class="subtle" id="bb-readiness-sub">Snapshot signals (shell)</div>
                      </div>
                      <!--  ===================== Readiness Overview (Screenshot Concept) =====================  -->
                      <div class="ro-wrap" id="bb-readiness-wrap">
                        <div class="ro-inner">
                          <div class="ro-grid">
                            <!--  Affordability Zone (keeps ID bb-mini-afford)  -->
                            <!--  ✅ Default needle position set for visual confirmation; runtime may override  -->
                            <div class="ro-card ro-gaugeCard" id="bb-mini-afford" style="--bb-afford:80;">
                              <div class="ro-head">
                                <div class="ro-title">
                                  <span class="ro-badge" aria-hidden="true">
                                    <!--  $ icon  -->
                                    <svg viewbox="0 0 24 24">
                                      <path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm1 5h-2v1.05c-1.8.28-3 1.43-3 3.05 0 1.86 1.25 2.6 3.18 3.06l.82.2c1.3.32 1.99.62 1.99 1.37 0 .74-.7 1.23-1.99 1.23-1.2 0-2.05-.44-2.66-1.12l-1.4 1.4c.82.92 2 1.5 3.06 1.66V17h2v-1.06c1.92-.31 3-1.58 3-3.02 0-1.9-1.26-2.7-3.4-3.2l-.74-.18c-1.21-.3-1.86-.58-1.86-1.22 0-.66.65-1.15 1.74-1.15 1.02 0 1.78.38 2.22.83l1.3-1.3c-.66-.65-1.5-1.03-2.26-1.18V7z"></path>
                                    </svg>
                                  </span>
                                  Affordability Zone
                                </div>
                                <div class="subtle" style="white-space:nowrap;">Snapshot signals (shell)</div>
                              </div>
                              <div class="ro-body">
                                <div class="ro-gauge" aria-hidden="true">
                                  <!--  Simple SVG gauge  -->
                                  <svg viewbox="0 0 200 140">
                                    <!--  track  -->
                                    <path d="M20 120 A80 80 0 0 1 180 120" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="18" stroke-linecap="round"></path>
                                    <!--  progress (≈80%)  -->
                                    <path d="M20 120 A80 80 0 0 1 154 64" fill="none" stroke="rgba(142,243,197,.92)" stroke-width="18" stroke-linecap="round"></path>
                                    <!--  glow  -->
                                    <path d="M20 120 A80 80 0 0 1 154 64" fill="none" stroke="rgba(106,167,255,.55)" stroke-width="10" stroke-linecap="round" opacity=".45"></path>
                                  </svg>
                                  <!--  ✅ NEEDLE / POINTER (replaces checkmark)  -->
                                  <div class="ro-gaugeTicks" aria-hidden="true">
                                    <i class="major"></i><i></i><i></i><i></i><i class="major"></i><i></i><i></i><i></i><i class="major"></i>
                                  </div>
                                  <div class="ro-needle" aria-hidden="true"></div>
                                  <div class="ro-needleHub" aria-hidden="true"></div>
                                </div>
                                <div class="ro-score">
                                  <div class="ro-scoreBig"><span id="bb-mini-afford-pct">80</span><span class="pct">%</span></div>
                                  <div class="ro-scoreText"><b id="bb-mini-afford-text">STRONG</b> • WITHIN TARGET RANGE</div>
                                </div>
                              </div>
                            </div>
                            <!--  Financing Path (keeps ID bb-mini-fin)  -->
                            <div class="ro-card" id="bb-mini-fin">
                              <div class="ro-head">
                                <div class="ro-title">
                                  <span class="ro-iconBox blue" aria-hidden="true">
                                    <!--  star  -->
                                    <svg viewbox="0 0 24 24">
                                      <path d="M12 2l2.9 6.6 7.1.6-5.4 4.6 1.6 6.9L12 17.8 5.8 20.7l1.6-6.9L2 9.2l7.1-.6L12 2z"></path>
                                    </svg>
                                  </span>
                                  Financing Path
                                </div>
                              </div>
                              <div class="ro-metricBody">
                                <div class="ro-metricSub" id="bb-mini-fin-text">VA LOAN ~ LOW RISK</div>
                                <div class="ro-bar"><i style="width:95%;"></i></div>
                                <div class="ro-percent"><b id="bb-mini-fin-pct">95</b><span>%</span></div>
                              </div>
                            </div>
                            <!--  Debt Status (keeps ID bb-mini-debt)  -->
                            <div class="ro-card" id="bb-mini-debt">
                              <div class="ro-head">
                                <div class="ro-title">
                                  <span class="ro-iconBox gold" aria-hidden="true">
                                    <!--  card  -->
                                    <svg viewbox="0 0 24 24">
                                      <path d="M3 6a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v2H3V6zm0 5h21v7a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-7zm4 5h6v2H7v-2z"></path>
                                    </svg>
                                  </span>
                                  Debt Status
                                </div>
                              </div>
                              <div class="ro-metricBody">
                                <div class="ro-metricSub" id="bb-mini-debt-text">LOW ~ EXCELLENT</div>
                                <div class="ro-bar gold"><i style="width:90%;"></i></div>
                                <div class="ro-percent"><b id="bb-mini-debt-pct">90</b><span>%</span></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div style="height:12px;"></div>
                      <div class="panel-h">
                        <div class="panel-title">Buyer Preferences</div>
                        <div class="subtle" id="bb-preferences-sub">Core constraints (shell)</div>
                      </div>
                      <!--  ===================== Buyer Preferences (Screenshot Concept) =====================  -->
                      <div class="pref-grid">
                        <div class="pref" id="bb-pref-areas">
                          <div class="pref-ico tone-mint" aria-hidden="true">
                            <svg viewbox="0 0 24 24">
                              <path d="M12 2c3.3 0 6 2.7 6 6 0 4.5-6 14-6 14S6 12.5 6 8c0-3.3 2.7-6 6-6zm0 8.5A2.5 2.5 0 1 0 12 5.5a2.5 2.5 0 0 0 0 5z"></path>
                            </svg>
                          </div>
                          <div class="pref-lines">
                            <div class="pref-k">Areas</div>
                            <div class="pref-v" id="bb-pref-areas-v">Near Base / Springfield</div>
                          </div>
                        </div>
                        <div class="pref" id="bb-pref-type">
                          <div class="pref-ico tone-blue" aria-hidden="true">
                            <svg viewbox="0 0 24 24">
                              <path d="M4 21V10l8-7 8 7v11h-6v-6H10v6H4z"></path>
                            </svg>
                          </div>
                          <div class="pref-lines">
                            <div class="pref-k">Property</div>
                            <div class="pref-v" id="bb-pref-type-v">Single Family Home</div>
                          </div>
                        </div>
                        <div class="pref" id="bb-pref-beds">
                          <div class="pref-ico tone-mint" aria-hidden="true">
                            <svg viewbox="0 0 24 24">
                              <path d="M7 10V7a3 3 0 0 1 6 0v3h4a3 3 0 0 1 3 3v5h-2v-2H6v2H4v-5a3 3 0 0 1 3-3zm2 0h2V7a1 1 0 0 0-2 0v3z"></path>
                            </svg>
                          </div>
                          <div class="pref-lines">
                            <div class="pref-k">Beds / Baths</div>
                            <div class="pref-v" id="bb-pref-beds-v">3–4 Beds, 2+ Baths</div>
                          </div>
                        </div>
                        <div class="pref" id="bb-pref-must">
                          <div class="pref-ico tone-gold" aria-hidden="true">
                            <svg viewbox="0 0 24 24">
                              <path d="M7 7h10v2H7V7zm-2 4h14v2H5v-2zm2 4h10v2H7v-2z"></path>
                            </svg>
                          </div>
                          <div class="pref-lines">
                            <div class="pref-k">Must Haves</div>
                            <div class="pref-v" id="bb-pref-must-v">Garage, Fenced Yard</div>
                          </div>
                        </div>
                        <div class="pref" id="bb-pref-timeline">
                          <div class="pref-ico tone-mint" aria-hidden="true">
                            <svg viewbox="0 0 24 24">
                              <path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm1-10.6V6h-2v6l5 3 .9-1.6-3.9-2z"></path>
                            </svg>
                          </div>
                          <div class="pref-lines">
                            <div class="pref-k">Timeline Priority</div>
                            <div class="pref-v" id="bb-pref-timeline-v">Move-in ready • Fast close</div>
                          </div>
                        </div>
                        <div class="pref" id="bb-pref-dealbreakers">
                          <div class="pref-ico tone-pink" aria-hidden="true">
                            <svg viewbox="0 0 24 24">
                              <path d="M12 2l9 4v6c0 5-3.8 9.7-9 10-5.2-.3-9-5-9-10V6l9-4zm4.3 7.3l-1.4-1.4L12 10.8 9.1 7.9 7.7 9.3 10.6 12.2 7.7 15.1l1.4 1.4 2.9-2.9 2.9 2.9 1.4-1.4-2.9-2.9 2.9-2.9z"></path>
                            </svg>
                          </div>
                          <div class="pref-lines">
                            <div class="pref-k">Dealbreakers</div>
                            <div class="pref-v" id="bb-pref-dealbreakers-v">No major repairs • No flood zone</div>
                          </div>
                        </div>
                      </div>
                    </section>
                    <!--  LEFT: ITEM DETAILS EDITOR  -->
                    <section id="bb-left-editor">
                      <div class="bb-edit-head">
                        <div class="bb-edit-title">
                          Timeline Item Details
                          <span class="bb-pill" id="bb-edit-pill">Selected</span>
                        </div>
                        <button class="bb-x" id="bb-edit-close" type="button" title="Close">
                          <span aria-hidden="true">✕</span>
                        </button>
                      </div>
                      <div class="bb-form" id="bb-edit-form">
                        <div class="bb-field">
                          <div class="bb-label">Title</div>
                          <input class="bb-input" id="bb-edit-title" placeholder="e.g., Pre-Approval Ready">
                        </div>
                        <div class="bb-row2">
                          <div class="bb-field">
                            <div class="bb-label">Type</div>
                            <select class="bb-select" id="bb-edit-type">
                              <option value="Milestone">Milestone</option>
                              <option value="Checklist">Checklist</option>
                              <option value="Status">Status</option>
                              <option value="Deadline">Deadline</option>
                            </select>
                          </div>
                          <div class="bb-field">
                            <div class="bb-label">Priority</div>
                            <select class="bb-select" id="bb-edit-priority">
                              <option value="Normal">Normal</option>
                              <option value="High">High</option>
                              <option value="Critical">Critical</option>
                            </select>
                          </div>
                        </div>
                        <div class="bb-row2">
                          <div class="bb-field">
                            <div class="bb-label">Owner / Assignee</div>
                            <input class="bb-input" id="bb-edit-owner" placeholder="e.g., Elena / Agent / Buyer">
                          </div>
                          <div class="bb-field">
                            <div class="bb-label">Status</div>
                            <select class="bb-select" id="bb-edit-status">
                              <option value="ok">On Track</option>
                              <option value="warn">At Risk</option>
                              <option value="bad">Blocked</option>
                            </select>
                          </div>
                        </div>
                        <div class="bb-field">
                          <div class="bb-label">Notes</div>
                          <textarea class="bb-textarea" id="bb-edit-notes" placeholder="Short context, next steps, dependencies..."></textarea>
                        </div>
                        <div class="bb-attach">
                          <span>Attachments (prototype)</span>
                          <button type="button" id="bb-edit-attach">Add</button>
                        </div>
                        <div class="bb-actions">
                          <button class="bb-action" type="button" id="bb-edit-cancel">Cancel</button>
                          <button class="bb-action primary" type="button" id="bb-edit-save">Save</button>
                        </div>
                      </div>
                    </section>
                  </div><!--  /bb-left-stack  -->
                </div>
              </div>
              <!--  RIGHT COLUMN  -->
              <div class="panel" id="bb-right">
                <div class="panel-inner">
                  <div class="bb-stack" id="bb-right-stack">
                    <!--  RIGHT: BRIEF MODE  -->
                    <section class="is-on" id="bb-right-brief">
                      <div class="elena-head">
                        <div class="elena-ring" aria-hidden="true"></div>
                        <div class="elena-title" id="bb-elena-title">Elena’s Brief</div>
                      </div>
                      <div class="elena-mode" id="bb-elena-brief-mode">
                        <div class="elena-copy" id="bb-elena-brief">
                          This buyer is financially stable within the $420K–$480K range and is motivated by an upcoming PCS within 60 days.
                          VA loan likely with low risk.
                          Recommend early showings near base focusing on move-in ready properties and a swift closing.
                        </div>
                      </div>
                    </section>
                    <!--  RIGHT: CALENDAR MODE  -->
                    <section id="bb-right-calendar">
                      <div class="bb-edit-head">
                        <div class="bb-edit-title">
                          Calendar + Assignee
                          <span class="bb-pill" id="bb-cal-pill">Select a date</span>
                        </div>
                        <button class="bb-x" id="bb-cal-close" type="button" title="Close">
                          <span aria-hidden="true">✕</span>
                        </button>
                      </div>
                      <div class="bb-cal-grid">
                        <div class="bb-helper" id="bb-cal-helper">
                          Pick a target date/time for this timeline item. (Prototype calendar)
                        </div>
                        <div class="bb-cal-month">
                          <strong id="bb-cal-monthLabel">April 2026</strong>
                          <div class="bb-cal-nav">
                            <button type="button" id="bb-cal-prev" aria-label="Previous">‹</button>
                            <button type="button" id="bb-cal-next" aria-label="Next">›</button>
                          </div>
                        </div>
                        <div class="bb-cal-days" id="bb-cal-days">
                          <div class="bb-cal-dow">S</div>
                          <div class="bb-cal-dow">M</div>
                          <div class="bb-cal-dow">T</div>
                          <div class="bb-cal-dow">W</div>
                          <div class="bb-cal-dow">T</div>
                          <div class="bb-cal-dow">F</div>
                          <div class="bb-cal-dow">S</div>
                          <!--  days injected by JS  -->
                        </div>
                        <div class="bb-user-row">
                          <div class="bb-field">
                            <div class="bb-label">User</div>
                            <input class="bb-input" id="bb-cal-user" placeholder="e.g., Buyer / Agent / Elena">
                          </div>
                        </div>
                        <div class="bb-time-row">
                          <div class="bb-field">
                            <div class="bb-label">Time</div>
                            <input class="bb-input" id="bb-cal-time" placeholder="e.g., 10:00 AM">
                          </div>
                          <div class="bb-field">
                            <div class="bb-label">Location</div>
                            <input class="bb-input" id="bb-cal-loc" placeholder="e.g., Zoom / Base / Listing">
                          </div>
                        </div>
                        <div class="bb-actions">
                          <button class="bb-action" type="button" id="bb-cal-clear">Clear</button>
                          <button class="bb-action primary" type="button" id="bb-cal-apply">Apply to Item</button>
                        </div>
                      </div>
                    </section>
                  </div><!--  /bb-right-stack  -->
                </div>
              </div>
            </div><!--  /bb-grid  -->
            <!--  TIMELINE  -->
            <div class="timeline-wrap" id="bb-timeline-wrap">
              <div class="timeline-head">
                <div class="timeline-title">Timeline &amp; PCS Status</div>
                <div class="timeline-hint">Click a node → edit context → save → updates</div>
              </div>
              <div class="timeline" id="bb-timeline">
                <div class="t-viewport" id="bb-timeline-viewport">
                  <div class="t-inner" id="bb-timeline-inner">
                    <span class="t-boundary left" aria-hidden="true"></span>
                    <span class="t-boundary right" aria-hidden="true"></span>
                    <div class="t-months" id="bb-months">
                      <div class="t-month"><span>Apr</span><span style="opacity:.55; font-weight:900;">|</span></div>
                      <div class="t-month"><span>May</span><span style="opacity:.55; font-weight:900;">|</span></div>
                      <div class="t-month"><span>Jun</span><span style="opacity:.55; font-weight:900;">|</span></div>
                      <div class="t-month"><span>Jul</span><span style="opacity:.55; font-weight:900;">|</span></div>
                    </div>
                    <div class="t-weeks" id="bb-week-ticks" aria-hidden="true">
                      <span class="tick major"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span>
                      <span class="tick major"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span>
                      <span class="tick major"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span>
                      <span class="tick major"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span>
                      <span class="tick major"></span>
                    </div>
                    <div class="rail" aria-hidden="true">
                      <span class="fill"></span>
                    </div>
                    <div class="nodes" id="bb-nodes">
                      <div class="node" id="bb-node-1" data-kind="Milestone">
                        <span class="pin ok"></span>
                        <div class="node-title">Orders Received</div>
                        <small class="node-kind">Milestone</small>
                      </div>
                      <div class="node" id="bb-node-2" data-kind="Checklist">
                        <span class="pin ok"></span>
                        <div class="node-title">Pre-Approval Ready</div>
                        <small class="node-kind">Checklist</small>
                      </div>
                      <div class="node" id="bb-node-3" data-kind="Status">
                        <span class="pin ok"></span>
                        <div class="node-title">Ideal Move Date: 4–6 Weeks</div>
                        <small class="node-kind">Status</small>
                      </div>
                      <div class="node" id="bb-node-4" data-kind="Deadline">
                        <span class="pin warn"></span>
                        <div class="node-title">Target Close: By Aug 15</div>
                        <small class="node-kind">Deadline</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!--  /bb-body  -->
          <!--  ✅ FOOTER REMOVED (ghost kept for runtime safety)  -->
          <div class="bb-footer-ghost" aria-hidden="true">
            <button id="bb-btn-accept" type="button" aria-disabled="true">Accept Buyer Connection</button>
            <button id="bb-btn-details" type="button" aria-disabled="true">Request Full Details</button>
            <button id="bb-btn-export" type="button" aria-disabled="true">Export to CRM</button>
          </div>
        </div><!--  /bb-frame  -->
      </div><!--  /bb-app  -->
    </div><!--  /bb-shell  -->
  </div>
  <div class="w-embed w-script">
    <script>
/* ============================================================
  BuyerBrief™ • 2A INTERACTION (MERGED)
  v1.2.0 (tick-density rail anchor FIX)
  ✅ Click node → edit/calendar (if those panels exist)
  ✅ Drag PIN → reposition node on timeline
  ✅ Save/load timeline to Supabase (via /api/buyerbrief-timeline)
  ✅ localStorage fallback always
  ✅ NEW (v1.2.0):
  - Date Indicators on Timeline:
    • If a node has dateISO (YYYY-MM-DD), create a marker on the rail
    • Clicking marker opens editor + calendar for that node
    • Multi-items on same date show a count badge
  ✅ FIX (this pass):
  - Your circles were anchoring to the SCROLLBAR track (blue segment bar).
  - We now anchor to the REAL timeline rail by detecting "tick density":
    The correct rail contains many small tick mark elements; the scrollbar does not.
============================================================ */
(() => {
  const root = document.getElementById("bb-shell");
  if (!root) return;
  if (window.BB2A && window.BB2A.__mounted) return;
  const BB = (window.BB2A = window.BB2A || {});
  BB.__mounted = true;
  const VERSION = "2A-timeline.v1";
  const LS_KEY = "buyerbrief.timeline.v1";
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));
  function readJSON(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }
    catch{ return null; }
  }
  function getEmail(){
    const pc = readJSON("pcsunited.identity");
    if (pc && pc.email) return String(pc.email).trim().toLowerCase();
    const rs = readJSON("realtysass.identity");
    if (rs && rs.email) return String(rs.email).trim().toLowerCase();
    const legacy = localStorage.getItem("realtysass.loginEmail");
    if (legacy) return String(legacy).trim().toLowerCase();
    return "";
  }
  function getParam(name){
    try { return new URLSearchParams(location.search).get(name) || ""; }
    catch { return ""; }
  }
  function inferBuyerBriefIdFromShell(){
    const el = $("#bb-buyer-name");
    const txt = (el && el.textContent) ? el.textContent.trim() : "";
    const m = txt.match(/#\s*(\d{3,8})/);
    if (m && m[1]) return `PCS-${m[1]}`;
    return "";
  }
  function getBuyerBriefId(){
    return getParam("buyerbrief_id") || getParam("bb") || inferBuyerBriefIdFromShell() || "PCS-0000";
  }
  function pickApiBase(){
    const host = String(location.hostname || "");
    if (host.endsWith(".webflow.io")) return "https://pcsunited.netlify.app/api";
    return "/api";
  }
  const API_BASE = pickApiBase();
  const API_ENDPOINT = `${API_BASE}/buyerbrief-timeline`;
  function safeText(el){ return (el && el.textContent || "").trim(); }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  // --------------------------------------------
  // Elements
  // --------------------------------------------
  const leftPanel = $("#bb-left");
  const rightPanel = $("#bb-right");
  const leftBrief = $("#bb-left-brief");
  const leftEditor = $("#bb-left-editor");
  const rightBrief = $("#bb-right-brief");
  const rightCalendar = $("#bb-right-calendar");
  const timeline = $("#bb-timeline");
  const timelineInner = $("#bb-timeline-inner");
  const viewport = $("#bb-timeline-viewport");
  const nodesWrap = $("#bb-nodes");
  const nodes = $$("#bb-nodes .node");
  const editClose = $("#bb-edit-close");
  const editCancel = $("#bb-edit-cancel");
  const editSave = $("#bb-edit-save");
  const calClose = $("#bb-cal-close");
  const calApply = $("#bb-cal-apply");
  const calClear = $("#bb-cal-clear");
  const calPrev = $("#bb-cal-prev");
  const calNext = $("#bb-cal-next");
  const fTitle = $("#bb-edit-title");
  const fType = $("#bb-edit-type");
  const fPriority = $("#bb-edit-priority");
  const fOwner = $("#bb-edit-owner");
  const fStatus = $("#bb-edit-status");
  const fNotes = $("#bb-edit-notes");
  const pill = $("#bb-edit-pill");
  const calMonthLabel = $("#bb-cal-monthLabel");
  const calDays = $("#bb-cal-days");
  const calPill = $("#bb-cal-pill");
  const calTime = $("#bb-cal-time");
  const calLoc = $("#bb-cal-loc");
  const hintEl = $(".timeline-hint");
  function setHint(msg){ if (hintEl) hintEl.textContent = msg; }
  // --------------------------------------------
  // State
  // --------------------------------------------
  const state = {
    email: getEmail(),
    buyerbrief_id: getBuyerBriefId(),
    activeNodeId: null,
    nodes: [],
    cal: { y: 2026, m: 3, selectedISO: null },
    __saveTimer: null,
    __drag: null,
    timelineRange: { startISO: "", endISO: "" },
  };
  // --------------------------------------------
  // Styles
  // --------------------------------------------
  function injectIndicatorStyles(){
    if (document.getElementById("bb2a-indicator-styles")) return;
    const s = document.createElement("style");
    s.id = "bb2a-indicator-styles";
    s.textContent = `
      #bb-date-markers{
        position:absolute;
        left:0; right:0;
        height: 24px;
        pointer-events:none;
        z-index: 6;
      }
      .bb-date-marker{
        position:absolute;
        top: 6px;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        border-radius: 999px;
        border: 1px solid rgba(142,243,197,.30);
        background:
          radial-gradient(circle at 35% 30%, rgba(255,255,255,.35), rgba(0,0,0,0) 55%),
          radial-gradient(circle at 50% 60%, rgba(142,243,197,.55), rgba(106,167,255,.25) 70%, rgba(0,0,0,0) 78%),
          rgba(0,0,0,.25);
        box-shadow:
          0 0 0 4px rgba(142,243,197,.10),
          0 16px 28px rgba(0,0,0,.35);
        cursor:pointer;
        pointer-events:auto;
      }
      .bb-date-marker:hover{
        border-color: rgba(142,243,197,.55);
        box-shadow:
          0 0 0 5px rgba(142,243,197,.14),
          0 18px 34px rgba(0,0,0,.38);
      }
      .bb-date-marker .bb-date-badge{
        position:absolute;
        top: -8px;
        right: -10px;
        min-width: 18px;
        height: 18px;
        padding: 0 6px;
        border-radius: 999px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size: 11px;
        font-weight: 900;
        color: rgba(233,236,255,.92);
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(0,0,0,.35);
        box-shadow: 0 10px 18px rgba(0,0,0,.35);
      }
      .bb-date-marker[data-status="warn"]{
        border-color: rgba(255,204,102,.45);
        box-shadow:
          0 0 0 4px rgba(255,204,102,.10),
          0 16px 28px rgba(0,0,0,.35);
      }
      .bb-date-marker[data-status="warn"]:hover{
        border-color: rgba(255,204,102,.70);
        box-shadow:
          0 0 0 5px rgba(255,204,102,.14),
          0 18px 34px rgba(0,0,0,.38);
      }
    `;
    document.head.appendChild(s);
  }
  // --------------------------------------------
  // Panels
  // --------------------------------------------
  function setOn(el, on){ if (!el) return; el.classList.toggle("is-on", !!on); }
  function focusPanels(on){
    leftPanel?.classList.toggle("bb-morph-focus", !!on);
    rightPanel?.classList.toggle("bb-morph-focus", !!on);
  }
  function setMode(mode){
    if (mode === "brief"){
      setOn(leftBrief, true);
      setOn(leftEditor, false);
      setOn(rightBrief, true);
      setOn(rightCalendar, false);
      focusPanels(false);
      nodes.forEach(n => n.classList.remove("is-active"));
      state.activeNodeId = null;
    } else {
      setOn(leftBrief, false);
      setOn(leftEditor, true);
      setOn(rightBrief, false);
      setOn(rightCalendar, true);
      focusPanels(true);
    }
  }
  // --------------------------------------------
  // Node model
  // --------------------------------------------
  function getNodeById(id){ return id ? document.getElementById(id) : null; }
  function readNodeModel(node, idx){
    const titleEl = node?.querySelector(".node-title") || node?.querySelector("div");
    const kindEl = node?.querySelector(".node-kind") || node?.querySelector("small");
    const pin = node?.querySelector(".pin");
    const statusFromPin = pin?.classList.contains("warn") ? "warn" : "ok";
    const defaultXPct = Math.round(((idx + 1) / (nodes.length + 1)) * 100);
    return {
      id: node?.id || `node-${idx+1}`,
      title: safeText(titleEl) || "Untitled",
      kind: safeText(kindEl) || (node?.getAttribute("data-kind") || "Milestone"),
      priority: node?.getAttribute("data-priority") || "Normal",
      owner: node?.getAttribute("data-owner") || "",
      status: node?.getAttribute("data-status") || statusFromPin,
      notes: node?.getAttribute("data-notes") || "",
      dateISO: node?.getAttribute("data-date") || "",
      time: node?.getAttribute("data-time") || "",
      location: node?.getAttribute("data-location") || "",
      xPct: Number(node?.getAttribute("data-xpct") || defaultXPct) || defaultXPct
    };
  }
  function writeNodeModel(node, model){
    if (!node) return;
    node.setAttribute("data-kind", model.kind || "");
    node.setAttribute("data-priority", model.priority || "Normal");
    node.setAttribute("data-owner", model.owner || "");
    node.setAttribute("data-status", model.status || "ok");
    node.setAttribute("data-notes", model.notes || "");
    node.setAttribute("data-date", model.dateISO || "");
    node.setAttribute("data-time", model.time || "");
    node.setAttribute("data-location", model.location || "");
    node.setAttribute("data-xpct", String(model.xPct ?? ""));
    const titleEl = node.querySelector(".node-title") || node.querySelector("div");
    const kindEl = node.querySelector(".node-kind") || node.querySelector("small");
    if (titleEl) titleEl.textContent = model.title || "Untitled";
    if (kindEl) kindEl.textContent = model.kind || "Milestone";
    const pin = node.querySelector(".pin");
    if (pin){
      pin.classList.remove("ok","warn");
      if (model.status === "warn") pin.classList.add("warn");
      else pin.classList.add("ok");
    }
  }
  // --------------------------------------------
  // Editor
  // --------------------------------------------
  function loadEditor(model){
    if (fTitle) fTitle.value = model.title || "";
    if (fType) fType.value = model.kind || "Milestone";
    if (fPriority) fPriority.value = model.priority || "Normal";
    if (fOwner) fOwner.value = model.owner || "";
    if (fStatus) fStatus.value = model.status || "ok";
    if (fNotes) fNotes.value = model.notes || "";
    if (pill) pill.textContent = `${model.kind} • ${model.priority}`;
    if (calTime) calTime.value = model.time || "";
    if (calLoc) calLoc.value = model.location || "";
    state.cal.selectedISO = model.dateISO || null;
    if (calPill) calPill.textContent = model.dateISO ? `Selected: ${model.dateISO}` : "Select a date";
  }
  function collectEditor(){
    return {
      title: (fTitle?.value || "").trim() || "Untitled",
      kind: fType?.value || "Milestone",
      priority: fPriority?.value || "Normal",
      owner: (fOwner?.value || "").trim(),
      status: fStatus?.value || "ok",
      notes: (fNotes?.value || "").trim(),
      dateISO: state.cal.selectedISO || "",
      time: (calTime?.value || "").trim(),
      location: (calLoc?.value || "").trim()
    };
  }
  // --------------------------------------------
  // Calendar
  // --------------------------------------------
  function daysInMonth(y, m){ return new Date(y, m+1, 0).getDate(); }
  function firstDow(y, m){ return new Date(y, m, 1).getDay(); }
  function iso(y,m,d){ return `${y}-${pad2(m+1)}-${pad2(d)}`; }
  function monthName(m){ return ["January","February","March","April","May","June","July","August","September","October","November","December"][m]; }
  function rebuildCalendar(){
    if (!calDays || !calMonthLabel) return;
    const y = state.cal.y;
    const m = state.cal.m;
    calMonthLabel.textContent = `${monthName(m)} ${y}`;
    const kids = Array.from(calDays.children);
    kids.slice(7).forEach(el => el.remove());
    const total = daysInMonth(y,m);
    const dow0 = firstDow(y,m);
    for (let i=0;i<dow0;i++){
      const b = document.createElement("div");
      b.className = "bb-day is-off";
      b.textContent = "";
      calDays.appendChild(b);
    }
    for (let d=1; d<=total; d++){
      const cell = document.createElement("div");
      const dateISO = iso(y,m,d);
      cell.className = "bb-day";
      cell.textContent = String(d);
      cell.dataset.iso = dateISO;
      if (state.cal.selectedISO === dateISO) cell.classList.add("is-on");
      cell.addEventListener("click", () => {
        if (cell.classList.contains("is-off")) return;
        state.cal.selectedISO = dateISO;
        if (calPill) calPill.textContent = `Selected: ${dateISO}`;
        $$("#bb-cal-days .bb-day").forEach(x => x.classList.remove("is-on"));
        cell.classList.add("is-on");
      });
      calDays.appendChild(cell);
    }
  }
  function gotoMonth(delta){
    let m = state.cal.m + delta;
    let y = state.cal.y;
    if (m < 0){ m = 11; y -= 1; }
    if (m > 11){ m = 0; y += 1; }
    state.cal.m = m; state.cal.y = y;
    rebuildCalendar();
  }
  // --------------------------------------------
  // Timeline range + mapping
  // --------------------------------------------
  function parseISODate(s){
    if (!s || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
    const [y,m,d] = s.split("-").map(Number);
    const dt = new Date(y, (m-1), d);
    if (Number.isNaN(dt.getTime())) return null;
    return dt;
  }
  function monthIndexFromLabel(lbl){
    const t = String(lbl || "").trim().toLowerCase();
    const map = {
      jan:0, january:0,
      feb:1, february:1,
      mar:2, march:2,
      apr:3, april:3,
      may:4,
      jun:5, june:5,
      jul:6, july:6,
      aug:7, august:7,
      sep:8, sept:8, september:8,
      oct:9, october:9,
      nov:10, november:10,
      dec:11, december:11
    };
    return (t in map) ? map[t] : null;
  }
  function computeTimelineRange(){
    const startAttr = timeline?.getAttribute("data-range-start") || timelineInner?.getAttribute("data-range-start") || "";
    const endAttr   = timeline?.getAttribute("data-range-end")   || timelineInner?.getAttribute("data-range-end")   || "";
    const aStart = parseISODate(startAttr);
    const aEnd   = parseISODate(endAttr);
    if (aStart && aEnd){
      state.timelineRange.startISO = startAttr;
      state.timelineRange.endISO = endAttr;
      return;
    }
    const monthSpans = Array.from(document.querySelectorAll("#bb-months .t-month span:first-child"));
    const labels = monthSpans.map(s => (s?.textContent || "").trim()).filter(Boolean);
    const startM = monthIndexFromLabel(labels[0]);
    const endM = monthIndexFromLabel(labels[labels.length - 1]);
    let y = (state.cal && Number(state.cal.y)) ? Number(state.cal.y) : (new Date()).getFullYear();
    if (startM == null || endM == null){
      const now = new Date();
      y = now.getFullYear();
      const m0 = now.getMonth();
      const start = new Date(y, m0, 1);
      const end = new Date(y, m0 + 4, 0);
      state.timelineRange.startISO = iso(start.getFullYear(), start.getMonth(), 1);
      state.timelineRange.endISO = iso(end.getFullYear(), end.getMonth(), end.getDate());
      return;
    }
    let endYear = y;
    if (endM < startM) endYear = y + 1;
    const start = new Date(y, startM, 1);
    const end = new Date(endYear, endM + 1, 0);
    state.timelineRange.startISO = iso(start.getFullYear(), start.getMonth(), 1);
    state.timelineRange.endISO = iso(end.getFullYear(), end.getMonth(), end.getDate());
  }
  function dateToXPct(dateISO){
    const start = parseISODate(state.timelineRange.startISO);
    const end = parseISODate(state.timelineRange.endISO);
    const dt = parseISODate(dateISO);
    if (!start || !end || !dt) return null;
    const t0 = start.getTime();
    const t1 = end.getTime();
    const t = dt.getTime();
    if (t1 <= t0) return null;
    const raw = ((t - t0) / (t1 - t0)) * 100;
    return clamp(raw, 4, 96);
  }
  // --------------------------------------------
  // Date Markers – anchor to REAL timeline rail (tick density)
  // --------------------------------------------
  function ensureMarkerLayer(){
    if (!timelineInner) return null;
    let layer = document.getElementById("bb-date-markers");
    if (layer) return layer;
    layer = document.createElement("div");
    layer.id = "bb-date-markers";
    timelineInner.appendChild(layer);
    return layer;
  }
  function isVisible(el){
    if (!el) return false;
    const cs = getComputedStyle(el);
    if (cs.display === "none" || cs.visibility === "hidden" || Number(cs.opacity) === 0) return false;
    const r = el.getBoundingClientRect();
    return r.width > 0 && r.height > 0;
  }
  // ✅ Core: find the bar that contains lots of tiny vertical tick marks
  function findRailByTickDensity(){
    if (!timelineInner) return null;
    const innerRect = timelineInner.getBoundingClientRect();
    const candidates = Array.from(timelineInner.querySelectorAll("div,section,header,article"))
      .filter(el => {
        if (!isVisible(el)) return false;
        const r = el.getBoundingClientRect();
        const wide = r.width >= innerRect.width * 0.70;
        const railishHeight = r.height >= 10 && r.height <= 54;
        const inside = r.top >= innerRect.top - 2 && r.bottom <= innerRect.bottom + 2;
        return wide && railishHeight && inside;
      });
    function tickScore(container){
      const r = container.getBoundingClientRect();
      if (r.width < 200) return -1;
      // Only scan a limited set of descendants for performance
      const kids = Array.from(container.querySelectorAll("div,span,i,em,strong"))
        .slice(0, 220);
      let ticks = 0;
      for (const el of kids){
        if (!isVisible(el)) continue;
        const rr = el.getBoundingClientRect();
        // Tick-like: very thin + small height
        const thin = rr.width <= 4;
        const short = rr.height >= 6 && rr.height <= 22;
        // Must be within this container box
        const inBox = rr.left >= r.left - 1 && rr.right <= r.right + 1 && rr.top >= r.top - 1 && rr.bottom <= r.bottom + 1;
        if (thin && short && inBox) ticks++;
      }
      // Prefer upper region (timeline rail is above; scrollbar is lower)
      const yMid = (r.top - innerRect.top) + (r.height / 2);
      const upperBonus = (yMid <= innerRect.height * 0.55) ? 25 : 0;
      // Density matters: ticks per width
      const density = ticks / Math.max(1, r.width);
      // Final score
      return (density * 10000) + (ticks * 2) + upperBonus - (Math.abs(18 - r.height) * 1.5);
    }
    let best = null;
    let bestScore = -Infinity;
    for (const c of candidates){
      const s = tickScore(c);
      if (s > bestScore){
        bestScore = s;
        best = c;
      }
    }
    // If nothing found, fallback to month/ticks containers if they exist
    return best || document.getElementById("bb-months") || null;
  }
  function positionMarkerLayerOnRail(layer){
    if (!layer || !timelineInner) return;
    const innerRect = timelineInner.getBoundingClientRect();
    const rail = findRailByTickDensity();
    // Fallback: place in top third
    let topPx = Math.round(innerRect.height * 0.30);
    if (rail){
      const railRect = rail.getBoundingClientRect();
      const railCenterY = (railRect.top - innerRect.top) + (railRect.height / 2);
      topPx = Math.round(railCenterY - 12);
      topPx = clamp(topPx, 8, Math.max(8, innerRect.height - 32));
    }
    layer.style.top = `${topPx}px`;
  }
  function scrollViewportToXPct(xPct){
    if (!viewport || !timelineInner) return;
    const innerRect = timelineInner.getBoundingClientRect();
    const viewRect = viewport.getBoundingClientRect();
    const x = (clamp(xPct, 0, 100) / 100) * innerRect.width;
    const target = clamp(x - (viewRect.width / 2), 0, Math.max(0, innerRect.width - viewRect.width));
    try { viewport.scrollTo({ left: target, behavior: "smooth" }); }
    catch { viewport.scrollLeft = target; }
  }
  function rebuildDateMarkers(){
    if (!timelineInner) return;
    if (!nodesWrap || nodes.length === 0) return;
    computeTimelineRange();
    injectIndicatorStyles();
    const layer = ensureMarkerLayer();
    if (!layer) return;
    // ✅ THIS is the fix: always anchor to the tick-dense timeline rail
    positionMarkerLayerOnRail(layer);
    layer.innerHTML = "";
    const byDate = new Map();
    state.nodes.forEach(n => {
      const dateISO = (n.dateISO || "").trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) return;
      if (!byDate.has(dateISO)) byDate.set(dateISO, []);
      byDate.get(dateISO).push({ id: n.id, status: n.status || "ok" });
    });
    Array.from(byDate.entries())
      .sort((a,b) => String(a[0]).localeCompare(String(b[0])))
      .forEach(([dateISO, arr]) => {
        const xPct = dateToXPct(dateISO);
        if (xPct == null) return;
        const markerStatus = arr.some(x => x.status === "warn") ? "warn" : "ok";
        const m = document.createElement("div");
        m.className = "bb-date-marker";
        m.style.left = `${xPct}%`;
        m.dataset.date = dateISO;
        m.dataset.status = markerStatus;
        const labelCount = arr.length > 1 ? `(${arr.length} items)` : `(1 item)`;
        m.title = `${dateISO} ${labelCount} — click to open`;
        if (arr.length > 1){
          const badge = document.createElement("div");
          badge.className = "bb-date-badge";
          badge.textContent = String(arr.length);
          m.appendChild(badge);
        }
        m.addEventListener("click", (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          const chosen = arr[0];
          const el = getNodeById(chosen.id);
          if (arr.length > 1){
            setHint(`Multiple items on ${dateISO} • Opened ${chosen.id}`);
          }
          scrollViewportToXPct(xPct);
          if (el) onNodeClick(el);
        });
        layer.appendChild(m);
      });
  }
  // --------------------------------------------
  // Persistence
  // --------------------------------------------
  function saveLocal(payload){
    const key = `${LS_KEY}:${state.buyerbrief_id}`;
    localStorage.setItem(key, JSON.stringify(payload));
  }
  function loadLocal(){
    const key = `${LS_KEY}:${state.buyerbrief_id}`;
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    try{ return JSON.parse(raw); } catch{ return null; }
  }
  async function apiPost(body){
    const res = await fetch(API_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body),
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok || !json.ok) throw new Error(json.error || `Request failed (${res.status})`);
    return json;
  }
  async function loadRemote(){
    if (!state.email) return null;
    const json = await apiPost({
      action: "get",
      email: state.email,
      buyerbrief_id: state.buyerbrief_id,
      version: VERSION
    });
    return json.row?.timeline_json || null;
  }
  async function saveRemote(timeline_json){
    if (!state.email) return null;
    const json = await apiPost({
      action: "upsert",
      email: state.email,
      buyerbrief_id: state.buyerbrief_id,
      version: VERSION,
      timeline_json
    });
    return json.row || null;
  }
  function buildTimelineJSON(){
    return {
      version: VERSION,
      buyerbrief_id: state.buyerbrief_id,
      email: state.email || null,
      savedAt: new Date().toISOString(),
      nodes: state.nodes.map(n => ({
        id: n.id,
        title: n.title,
        kind: n.kind,
        priority: n.priority,
        owner: n.owner,
        status: n.status,
        notes: n.notes,
        dateISO: n.dateISO,
        time: n.time,
        location: n.location,
        xPct: n.xPct
      }))
    };
  }
  function queueSave(){
    clearTimeout(state.__saveTimer);
    state.__saveTimer = setTimeout(async () => {
      const payload = buildTimelineJSON();
      saveLocal(payload);
      if (!state.email){
        setHint("Saved locally • (no email found)");
        return;
      }
      try{
        setHint("Saving…");
        await saveRemote(payload);
        setHint("Saved • Drag pin to adjust");
      } catch(e){
        console.warn("[BB2A] Remote save failed:", e);
        setHint("Saved locally • Remote save failed");
      }
    }, 550);
  }
  // --------------------------------------------
  // Timeline layout + drag
  // --------------------------------------------
  function prepNodesLayout(){
    if (!nodesWrap) return false;
    nodesWrap.style.position = "relative";
    nodesWrap.style.height = nodesWrap.style.height || "64px";
    nodes.forEach((n) => {
      n.style.position = "absolute";
      n.style.top = "0px";
      n.style.left = "50%";
      n.style.transform = "translateX(-50%)";
      n.style.userSelect = "none";
      n.style.touchAction = "none";
      n.style.width = n.style.width || "160px";
      n.style.maxWidth = "200px";
    });
    if (timelineInner){
      timelineInner.style.position = timelineInner.style.position || "relative";
    }
    return true;
  }
  function paintNodes(){
    if (!nodesWrap) return;
    state.nodes.forEach((m) => {
      const el = getNodeById(m.id);
      if (!el) return;
      const x = clamp(Number(m.xPct || 50), 4, 96);
      el.style.left = `${x}%`;
      el.setAttribute("data-xpct", String(x));
    });
  }
  function pctFromClientX(clientX, rect){
    const x = clientX - rect.left;
    return (x / rect.width) * 100;
  }
  function attachDrag(){
    if (!nodesWrap) return;
    nodes.forEach((nodeEl) => {
      const pin = nodeEl.querySelector(".pin");
      if (!pin) return;
      pin.style.cursor = "grab";
      pin.addEventListener("pointerdown", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        const rect = nodesWrap.getBoundingClientRect();
        nodeEl.setPointerCapture(ev.pointerId);
        pin.style.cursor = "grabbing";
        state.__drag = { nodeId: nodeEl.id, rect };
        const m = state.nodes.find(x => x.id === nodeEl.id);
        if (m){
          const p = clamp(pctFromClientX(ev.clientX, rect), 4, 96);
          m.xPct = Math.round(p);
          paintNodes();
        }
      });
      nodeEl.addEventListener("pointermove", (ev) => {
        if (!state.__drag || state.__drag.nodeId !== nodeEl.id) return;
        const m = state.nodes.find(x => x.id === nodeEl.id);
        if (!m) return;
        const rect = state.__drag.rect;
        const p = clamp(pctFromClientX(ev.clientX, rect), 4, 96);
        m.xPct = Math.round(p);
        paintNodes();
      });
      const end = (ev) => {
        if (!state.__drag || state.__drag.nodeId !== nodeEl.id) return;
        try { nodeEl.releasePointerCapture(ev.pointerId); } catch {}
        pin.style.cursor = "grab";
        state.__drag = null;
        queueSave();
      };
      nodeEl.addEventListener("pointerup", end);
      nodeEl.addEventListener("pointercancel", end);
    });
  }
  // --------------------------------------------
  // Click → edit
  // --------------------------------------------
  function onNodeClick(node){
    if (!leftEditor && !rightCalendar) return;
    const idx = nodes.findIndex(n => n.id === node.id);
    const model = state.nodes[idx] || readNodeModel(node, idx);
    state.activeNodeId = model.id;
    nodes.forEach(n => n.classList.toggle("is-active", n.id === model.id));
    loadEditor(model);
    if (model.dateISO && /^\d{4}-\d{2}-\d{2}$/.test(model.dateISO)){
      const [yy,mm] = model.dateISO.split("-").map(Number);
      state.cal.y = yy;
      state.cal.m = clamp(mm-1, 0, 11);
    }
    rebuildCalendar();
    setMode("edit");
  }
  function onSave(){
    const node = getNodeById(state.activeNodeId);
    if (!node) return setMode("brief");
    const idx = nodes.findIndex(n => n.id === node.id);
    const existing = state.nodes[idx] || readNodeModel(node, idx);
    const updated = { ...existing, ...collectEditor() };
    state.nodes[idx] = updated;
    writeNodeModel(node, updated);
    node.animate?.(
      [{ transform:"translateX(-50%) translateY(-1px) scale(1.01)" }, { transform:"translateX(-50%) translateY(0) scale(1)" }],
      { duration: 220, easing:"ease-out" }
    );
    rebuildDateMarkers();
    queueSave();
    setMode("brief");
  }
  function onCancel(){ setMode("brief"); }
  function onApplyCalendar(){
    if (calPill) calPill.textContent = state.cal.selectedISO ? `Selected: ${state.cal.selectedISO}` : "Select a date";
    calPill?.animate?.([{ opacity:.6 },{ opacity:1 }], { duration: 180, easing:"ease-out" });
  }
  function onClearCalendar(){
    state.cal.selectedISO = null;
    if (calPill) calPill.textContent = "Select a date";
    rebuildCalendar();
  }
  // --------------------------------------------
  // Hydrate
  // --------------------------------------------
  async function hydrate(){
    if (!nodesWrap || nodes.length === 0) return;
    prepNodesLayout();
    state.nodes = nodes.map((n, idx) => readNodeModel(n, idx));
    let loaded = null;
    if (state.email){
      try{
        setHint("Loading…");
        loaded = await loadRemote();
      } catch(e){
        console.warn("[BB2A] Remote load failed:", e);
      }
    }
    if (!loaded) loaded = loadLocal();
    if (loaded && Array.isArray(loaded.nodes)){
      loaded.nodes.forEach((saved) => {
        const i = state.nodes.findIndex(x => x.id === saved.id);
        if (i === -1) return;
        state.nodes[i] = {
          ...state.nodes[i],
          ...saved,
          xPct: typeof saved.xPct === "number" ? saved.xPct : state.nodes[i].xPct
        };
        const el = getNodeById(saved.id);
        if (el) writeNodeModel(el, state.nodes[i]);
      });
    }
    paintNodes();
    attachDrag();
    // ✅ markers anchored AFTER layout + hydration
    rebuildDateMarkers();
    nodes.forEach(n => {
      n.addEventListener("click", () => onNodeClick(n));
      n.setAttribute("role","button");
      n.setAttribute("tabindex","0");
      n.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          onNodeClick(n);
        }
      });
    });
    editClose?.addEventListener("click", onCancel);
    editCancel?.addEventListener("click", onCancel);
    editSave?.addEventListener("click", onSave);
    calClose?.addEventListener("click", onCancel);
    calApply?.addEventListener("click", onApplyCalendar);
    calClear?.addEventListener("click", onClearCalendar);
    calPrev?.addEventListener("click", () => gotoMonth(-1));
    calNext?.addEventListener("click", () => gotoMonth(1));
    rebuildCalendar();
    if (!state.email) setHint("Saved locally • (no email found)");
    else setHint("Saved • Drag pin to adjust");
    window.addEventListener("resize", () => {
      paintNodes();
      rebuildDateMarkers();
    });
    setMode("brief");
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", hydrate);
  } else {
    hydrate();
  }
})();
</script>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  "use strict";
  // ============================================================
  // BuyerBrief™ • 2B — Ask Elena INSIDE Elena's Brief Box
  // v0.2.4 (REMOVE INNER COMPOSER BOX COMPLETELY)
  //
  // ✅ ONLY shows: Ask-Elena textbox + SEND button
  // ✅ Composer still sticky-bottom
  // ✅ Chat scrolls inside the main box
  //
  // ✅ UPDATE:
  // - Removes the "second box" by stripping ALL wrapper styling
  //   from the row and the composer panel.
  // ============================================================
  if (window.BB_ELENA_CHAT && window.BB_ELENA_CHAT.__mounted) return;
  const MOD = (window.BB_ELENA_CHAT = window.BB_ELENA_CHAT || {});
  MOD.__mounted = true;
  const $ = (q) => document.querySelector(q);
  // ------------------------------------------------------------
  // Helpers
  // ------------------------------------------------------------
  function readJSON(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }
    catch{ return null; }
  }
  function writeJSON(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); } catch(_){}
  }
  function getParam(name){
    try { return new URLSearchParams(location.search).get(name) || ""; }
    catch { return ""; }
  }
  function inferBuyerBriefIdFromShell(){
    const el = $("#bb-buyer-name");
    const txt = (el && el.textContent) ? el.textContent.trim() : "";
    const m = txt.match(/#\s*(\d{3,8})/);
    if (m && m[1]) return `PCS-${m[1]}`;
    return "";
  }
  function getBuyerBriefId(){
    return getParam("buyerbrief_id") || getParam("bb") || inferBuyerBriefIdFromShell() || "PCS-0000";
  }
  function pickApiBase(){
    const host = String(location.hostname || "");
    if (host.endsWith(".webflow.io")) return "https://pcsunited.netlify.app/api";
    return "/api";
  }
  function getEmail(){
    const pc = readJSON("pcsunited.identity");
    if (pc && pc.email) return String(pc.email).trim().toLowerCase();
    const rs = readJSON("realtysass.identity");
    if (rs && rs.email) return String(rs.email).trim().toLowerCase();
    const bb = readJSON("buyerbrief.identity");
    if (bb && bb.email) return String(bb.email).trim().toLowerCase();
    const legacy = localStorage.getItem("realtysass.loginEmail");
    if (legacy) return String(legacy).trim().toLowerCase();
    return "";
  }
  function setEmail(email){
    const e = String(email || "").trim().toLowerCase();
    if (!e || !e.includes("@")) return false;
    writeJSON("buyerbrief.identity", { email: e, ts: Date.now() });
    const pc = readJSON("pcsunited.identity");
    if (!pc || !pc.email){
      writeJSON("pcsunited.identity", { email: e, ts: Date.now() });
    }
    return true;
  }
  function getIdentityObject(email){
    const pc = readJSON("pcsunited.identity");
    if (pc && pc.email) return { email: String(pc.email).trim().toLowerCase(), ts: Number(pc.ts || Date.now()) };
    return { email, ts: Date.now() };
  }
  // ------------------------------------------------------------
  // Target: the existing Elena brief box
  // ------------------------------------------------------------
  const box = $("#bb-elena-brief-mode");
  if (!box) return;
  if (box.querySelector("#bb-aeRoot")) return;
  // ============================================================
  // ✅ HARD LAYOUT GUARDRAILS
  // ============================================================
  box.style.display = "flex";
  box.style.flexDirection = "column";
  box.style.height = "100%";
  box.style.minHeight = "0";
  box.style.overflow = "hidden";
  box.style.position = "relative";
  // ------------------------------------------------------------
  // Styles (scoped)
  // ------------------------------------------------------------
  const style = document.createElement("style");
  style.textContent = `
    #bb-elena-brief-mode #bb-aeRoot,
    #bb-elena-brief-mode #bb-aeRoot *{
      box-sizing:border-box;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #bb-elena-brief-mode #bb-aeRoot{
      display:flex;
      flex-direction:column;
      height:100%;
      min-height:0;
      overflow:hidden;
      gap: 10px;
    }
    #bb-elena-brief-mode #bb-aeTop{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px 0 10px;
    }
    #bb-elena-brief-mode #bb-aeTop .bb-aeHint{
      color: rgba(233,236,255,.70);
      font-weight: 850;
      font-size: 12px;
      letter-spacing: .01em;
    }
    #bb-elena-brief-mode #bb-aeTop .bb-aePill{
      font-size: 10.5px;
      font-weight: 950;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(233,236,255,.78);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      white-space: nowrap;
    }
    #bb-elena-brief-mode #bb-aeChat{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      padding: 8px 10px 8px 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      scrollbar-width: none;
      overscroll-behavior: contain;
    }
    #bb-elena-brief-mode #bb-aeChat::-webkit-scrollbar{ display:none; }
    #bb-elena-brief-mode .bb-aeMsg{
      max-width: 92%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(233,236,255,.92);
      font-size: 12.8px;
      line-height: 1.45;
      white-space: pre-wrap;
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      backdrop-filter: blur(12px) saturate(150%);
    }
    #bb-elena-brief-mode .bb-aeMsg.user{
      align-self:flex-end;
      background: rgba(142,243,197,.08);
      border-color: rgba(142,243,197,.22);
      box-shadow: 0 0 16px rgba(142,243,197,.06);
    }
    #bb-elena-brief-mode .bb-aeMsg.bot{ align-self:flex-start; }
    #bb-elena-brief-mode .bb-aeTyping{ opacity:.85; font-size: 12px; }
    /* ============================================================
       ✅ NO "SECOND BOX"
       Composer = transparent, just padding. No border, no wash.
    ============================================================ */
    #bb-elena-brief-mode #bb-aeComposer{
      flex: 0 0 auto;
      position: sticky;
      bottom: 0;
      z-index: 5;
      padding: 12px 10px 14px 10px;
      background: transparent;
      border: 0;
      border-top: 0;
      border-radius: 0;
      box-shadow: none;
      -webkit-backdrop-filter: none;
      backdrop-filter: none;
    }
    /* Row is ONLY layout (no visuals) */
    #bb-elena-brief-mode .bb-aeRow,
    #bb-elena-brief-mode #bb-aeEmailRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 0;
      margin: 0;
      border: 0;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
    }
    #bb-elena-brief-mode #bb-aeEmailRow{ display:none; }
    /* Clean field (this is the only "box" now — the actual input) */
    #bb-elena-brief-mode .bb-aeInput{
      width:100%;
      outline:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color: rgba(233,236,255,.92);
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 800;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      min-height: 44px;
      -webkit-backdrop-filter: blur(14px) saturate(160%);
      backdrop-filter: blur(14px) saturate(160%);
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    #bb-elena-brief-mode .bb-aeInput::placeholder{ color: rgba(233,236,255,.42); }
    #bb-elena-brief-mode .bb-aeInput:focus{
      border-color: rgba(142,243,197,.26);
      box-shadow: 0 14px 24px rgba(0,0,0,.28), 0 0 0 2px rgba(142,243,197,.08);
      background: rgba(0,0,0,.18);
    }
    /* Button stays premium */
    #bb-elena-brief-mode .bb-aeBtn{
      height: 44px;
      padding: 0 14px;
      border: 0;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing: .12em;
      text-transform: uppercase;
      background: linear-gradient(180deg, rgba(142,243,197,1), rgba(106,167,255,.95));
      color:#06112b;
      box-shadow: 0 10px 18px rgba(0,0,0,.28);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
      user-select:none;
      white-space: nowrap;
    }
    #bb-elena-brief-mode .bb-aeBtn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 14px 22px rgba(0,0,0,.34);
    }
    #bb-elena-brief-mode .bb-aeBtn:active{ transform: translateY(0); filter: brightness(.99); }
    #bb-elena-brief-mode .bb-aeBtn:disabled{ opacity:.60; cursor:not-allowed; transform:none; box-shadow:none; }
  `;
  document.head.appendChild(style);
  // ------------------------------------------------------------
  // Replace the box content
  // ------------------------------------------------------------
  box.innerHTML = `
    <div id="bb-aeRoot">
      <div id="bb-aeTop">
        <div class="bb-aeHint">Ask Elena • Timeline • Strategy • Next steps</div>
        <div class="bb-aePill" id="bb-aeStatus">READY</div>
      </div>
      <div id="bb-aeChat" aria-live="polite"></div>
      <div id="bb-aeComposer">
        <div id="bb-aeEmailRow">
          <input id="bb-aeEmail" class="bb-aeInput" type="email" placeholder="Enter email (to personalize your brief)" autocomplete="email" />
          <button id="bb-aeEmailSave" class="bb-aeBtn" type="button">SAVE</button>
        </div>
        <div class="bb-aeRow">
          <input id="bb-aeInput" class="bb-aeInput" type="text" placeholder="Ask Elena… (Enter to send)" autocomplete="off" />
          <button id="bb-aeSend" class="bb-aeBtn" type="button">SEND</button>
        </div>
      </div>
    </div>
  `;
  // ------------------------------------------------------------
  // Runtime
  // ------------------------------------------------------------
  const API_BASE = pickApiBase();
  const ENDPOINT = `${API_BASE}/ask-elena`;
  const chat = box.querySelector("#bb-aeChat");
  const input = box.querySelector("#bb-aeInput");
  const send = box.querySelector("#bb-aeSend");
  const status = box.querySelector("#bb-aeStatus");
  const emailRow = box.querySelector("#bb-aeEmailRow");
  const emailInput = box.querySelector("#bb-aeEmail");
  const emailSave = box.querySelector("#bb-aeEmailSave");
  const state = {
    buyerbrief_id: getBuyerBriefId(),
    email: getEmail()
  };
  function setStatus(t){ if (status) status.textContent = t; }
  function scrollToBottom(){
    requestAnimationFrame(() => {
      try{ chat.scrollTop = chat.scrollHeight; } catch(_){}
    });
  }
  function addMsg(role, text, extraCls){
    const div = document.createElement("div");
    div.className = `bb-aeMsg ${role}` + (extraCls ? ` ${extraCls}` : "");
    div.textContent = text;
    chat.appendChild(div);
    scrollToBottom();
    return div;
  }
  function showTyping(){
    return addMsg("bot", "Elena is thinking…", "bb-aeTyping");
  }
  async function postJSON(url, body){
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    const txt = await r.text();
    let j = {};
    try{ j = JSON.parse(txt || "{}"); } catch { j = { raw: txt }; }
    if (!r.ok || j.ok === false) throw new Error(j.error || j.message || ("HTTP " + r.status));
    return j;
  }
  function ensureEmailUI(){
    state.email = getEmail();
    const has = !!(state.email && state.email.includes("@"));
    emailRow.style.display = has ? "none" : "grid";
    setStatus(has ? "READY" : "EMAIL NEEDED");
  }
  async function callElena(userText){
    state.email = getEmail();
    const email = (state.email || "").trim().toLowerCase();
    if (!email || !email.includes("@")){
      ensureEmailUI();
      addMsg("bot",
        "Drop your email above so I can pull your profile + write a correct brief. (I’ll only use it to personalize this BuyerBrief.)"
      );
      return;
    }
    send.disabled = true;
    setStatus("THINKING…");
    const typing = showTyping();
    try{
      let timeline = null;
      try{
        const raw = localStorage.getItem(`buyerbrief.timeline.v1:${state.buyerbrief_id}`);
        timeline = raw ? JSON.parse(raw) : null;
      }catch(_){}
      const payload = {
        message: userText,
        email: email,
        identity: getIdentityObject(email),
        context: {
          source: "webflow",
          widget: "buyerbrief-elena-brief-chat",
          buyerbrief_id: state.buyerbrief_id,
          page: { href: location.href, path: location.pathname },
          timeline: timeline || undefined
        }
      };
      const data = await postJSON(ENDPOINT, payload);
      try{ typing.remove(); } catch(_){}
      const reply = (data && data.reply) ? String(data.reply) : "I’m here — what do you want to decide next?";
      addMsg("bot", reply);
      setStatus("READY");
    } catch(e){
      try{ typing.remove(); } catch(_){}
      addMsg("bot", "Connection snag. Try again in a second.");
      setStatus("OFFLINE");
      console.warn("[BB 2B] ask-elena failed:", e);
    } finally {
      send.disabled = false;
    }
  }
  function sendNow(){
    const text = (input.value || "").trim();
    if (!text) return;
    addMsg("user", text);
    input.value = "";
    callElena(text);
  }
  send.addEventListener("click", sendNow);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      sendNow();
    }
  });
  emailSave.addEventListener("click", () => {
    const ok = setEmail(emailInput.value);
    if (ok){
      emailInput.value = "";
      ensureEmailUI();
      addMsg("bot", "Perfect. Now ask me anything about the timeline, risks, or next moves.");
    } else {
      addMsg("bot", "That email doesn’t look valid — try again.");
    }
  });
  emailInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      emailSave.click();
    }
  });
  // Hello
  ensureEmailUI();
  addMsg("bot",
    "I’m in your Elena’s Brief now — ask me for the next-best actions, timeline strategy, and what to lock in first."
  );
})();
</script>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  "use strict";
  // ============================================================
  // BuyerBrief™ • 2C — Buyers Data (Readiness + Preferences + Header)
  // v0.1.1
  //
  // ✅ Pull profile by email (Supabase via /api/profile-by-email)
  // ✅ Paint Buyer Preferences into existing Shell IDs
  // ✅ Paint Readiness Overview cards (if IDs exist)
  // ✅ NEW: Replace header text with:
  //        full_name (rank, family)
  //        Example: "Josue Orozco (O-3, Family)"
  //
  // Everything else stays the same.
  // ============================================================
  if (window.BB_2C_BUYERS && window.BB_2C_BUYERS.__mounted) return;
  const MOD = (window.BB_2C_BUYERS = window.BB_2C_BUYERS || {});
  MOD.__mounted = true;
  const $ = (q) => document.querySelector(q);
  // ============================================================
  // 1) Storage helpers
  // ============================================================
  function readJSON(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }
    catch{ return null; }
  }
  function writeJSON(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); } catch(_){}
  }
  // ============================================================
  // 2) Identity / BuyerBrief ID / API base
  // ============================================================
  function getParam(name){
    try { return new URLSearchParams(location.search).get(name) || ""; }
    catch { return ""; }
  }
  function inferBuyerBriefIdFromShell(){
    const el = $("#bb-buyer-name");
    const txt = (el && el.textContent) ? el.textContent.trim() : "";
    const m = txt.match(/#\s*(\d{3,8})/);
    if (m && m[1]) return `PCS-${m[1]}`;
    return "";
  }
  function getBuyerBriefId(){
    return getParam("buyerbrief_id") || getParam("bb") || inferBuyerBriefIdFromShell() || "PCS-0000";
  }
  function pickApiBase(){
    const host = String(location.hostname || "");
    if (host.endsWith(".webflow.io")) return "https://pcsunited.netlify.app/api";
    return "/api";
  }
  function getEmail(){
    const pc = readJSON("pcsunited.identity");
    if (pc && pc.email) return String(pc.email).trim().toLowerCase();
    const rs = readJSON("realtysass.identity");
    if (rs && rs.email) return String(rs.email).trim().toLowerCase();
    const bb = readJSON("buyerbrief.identity");
    if (bb && bb.email) return String(bb.email).trim().toLowerCase();
    const legacy = localStorage.getItem("realtysass.loginEmail");
    if (legacy) return String(legacy).trim().toLowerCase();
    return "";
  }
  function setEmail(email){
    const e = String(email || "").trim().toLowerCase();
    if (!e || !e.includes("@")) return false;
    writeJSON("buyerbrief.identity", { email: e, ts: Date.now() });
    const pc = readJSON("pcsunited.identity");
    if (!pc || !pc.email){
      writeJSON("pcsunited.identity", { email: e, ts: Date.now() });
    }
    return true;
  }
  // ============================================================
  // 3) Network helpers
  // ============================================================
  async function postJSON(url, body){
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    const txt = await r.text();
    let j = {};
    try{ j = JSON.parse(txt || "{}"); } catch { j = { raw: txt }; }
    if (!r.ok || j.ok === false) throw new Error(j.error || j.message || ("HTTP " + r.status));
    return j;
  }
  async function postWithFallback(paths, body){
    let lastErr = null;
    for (const url of paths){
      try{ return await postJSON(url, body); }
      catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("All endpoints failed");
  }
  // ============================================================
  // 4) DOM painters (safe)
  // ============================================================
  function setText(id, val){
    const el = document.getElementById(id);
    if (!el) return false;
    el.textContent = (val == null || val === "") ? "—" : String(val);
    return true;
  }
  function setTextAny(selectors, val){
    for (const sel of selectors){
      const el = document.querySelector(sel);
      if (el){
        el.textContent = (val == null || val === "") ? "—" : String(val);
        return true;
      }
    }
    return false;
  }
  function normNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function cleanList(v){
    if (!v) return "";
    if (Array.isArray(v)) return v.map(x => String(x || "").trim()).filter(Boolean).join(", ");
    return String(v).trim();
  }
  // ============================================================
  // 5) NEW: Header painter (full_name + (rank, family))
  // ============================================================
  function normalizeRank(raw){
    const map = {
      "E-1":"AB","E-2":"Amn","E-3":"A1C","E-4":"SrA","E-5":"SSgt","E-6":"TSgt","E-7":"MSgt","E-8":"SMSgt","E-9":"CMSgt",
      "O-1":"2d Lt","O-2":"1st Lt","O-3":"Capt","O-4":"Maj","O-5":"Lt Col","O-6":"Col"
    };
    const key = String(raw || "").trim();
    return map[key] || key;
  }
  function pickFullName(profile){
    const candidates = [
      profile?.full_name,
      profile?.fullName,
      profile?.name
    ];
    for (const v of candidates){
      const s = String(v || "").trim();
      if (s) return s;
    }
    const fn = String(profile?.first_name || profile?.firstName || "").trim();
    const ln = String(profile?.last_name || profile?.lastName || "").trim();
    if (fn && ln) return `${fn} ${ln}`;
    if (ln) return ln;
    return "";
  }
  function pickRankLabel(profile){
    const candidates = [
      profile?.rankTitle,
      profile?.rank_title,
      profile?.rank,
      profile?.rank_paygrade,
      profile?.paygrade
    ];
    for (const v of candidates){
      const s = String(v || "").trim();
      if (s) return normalizeRank(s);
    }
    return "—";
  }
  function pickFamilyLabel(profile){
    // Your systems often store dependents as boolean `family`
    const fam = profile?.family;
    if (fam === true) return "Family";
    if (fam === false) return "Single";
    // Some schemas store family_size
    const size = normNum(profile?.family_size ?? profile?.familySize);
    if (size && size > 1) return "Family";
    if (size === 1) return "Single";
    return "Family"; // safest default per your requested label format
  }
  function paintHeader(profile){
    const el = document.getElementById("bb-buyer-name");
    if (!el) return;
    const fullName = pickFullName(profile);
    if (!fullName) return; // if missing, don’t overwrite the existing PCS Buyer label
    const rank = pickRankLabel(profile);
    const family = pickFamilyLabel(profile);
    // Requested format: Full Name (rank, family)
    el.textContent = `${fullName} (${rank}, ${family})`;
  }
  // ============================================================
  // 6) Readiness sources (existing keys)
  // ============================================================
  function getVerdictPacket(){
    const a = readJSON("pcsunited.ec_verdict.v1");
    if (a && typeof a === "object") return a;
    const b = readJSON("realtysass.ec_verdict.v1");
    if (b && typeof b === "object") return b;
    const c = readJSON("realtysass.feasibility.v1");
    if (c && typeof c === "object") return c;
    return null;
  }
  function formatMoneyRange(lo, hi){
    const L = normNum(lo);
    const H = normNum(hi);
    if (!L && !H) return "";
    const fmt = (n) => {
      const x = Math.round(n);
      if (x >= 1000000) return "$" + (x/1000000).toFixed(2).replace(/\.00$/,"") + "M";
      if (x >= 1000) return "$" + Math.round(x/1000) + "K";
      return "$" + x;
    };
    if (L && H) return `${fmt(L)} – ${fmt(H)}`;
    if (L) return `From ${fmt(L)}`;
    return `Up to ${fmt(H)}`;
  }
  function deriveReadiness(profile, verdict){
    const status =
      (verdict?.status || verdict?.bluf || verdict?.state || verdict?.label || "").toString().trim().toUpperCase();
    const rangeText =
      (verdict?.targetRange || verdict?.range || verdict?.priceRange || "").toString().trim();
    const php = normNum(profile?.projected_home_price ?? profile?.projectedHomePrice);
    const fallbackRange = php ? formatMoneyRange(php * 0.95, php * 1.05) : "";
    const readinessZone =
      status.includes("GREEN") ? "GREEN" :
      status.includes("NO") ? "NO-GO" :
      status.includes("RED") ? "NO-GO" :
      status.includes("CAUTION") ? "CAUTION" :
      status.includes("YELLOW") ? "CAUTION" :
      status ? status : "UNKNOWN";
    const cs = normNum(profile?.credit_score ?? profile?.creditScore);
    let financing = "Needs intake";
    if (cs){
      if (cs >= 760) financing = "Strong (760+)";
      else if (cs >= 720) financing = "Good (720–759)";
      else if (cs >= 680) financing = "Fair (680–719)";
      else financing = "Work needed (<680)";
    }
    const exp = normNum(profile?.monthly_expenses ?? profile?.monthlyExpenses);
    const debt = exp ? "Captured (needs DTI)" : "Needs intake";
    return {
      readinessZone,
      financing,
      debt,
      range: rangeText || fallbackRange || "—"
    };
  }
  // ============================================================
  // 7) Buyer Preferences mapping (profile -> Shell IDs)
  // ============================================================
  function derivePreferences(profile){
    const beds = profile?.bedrooms;
    const baths = profile?.bathrooms;
    const bedsBaths = (() => {
      const b = normNum(beds);
      const ba = normNum(baths);
      if (b && ba) return `${b} bd / ${ba} ba`;
      if (b) return `${b} bd`;
      if (ba) return `${ba} ba`;
      return "";
    })();
    const propertyType = (profile?.property_type ?? profile?.propertyType ?? "").toString().trim();
    const amenities = cleanList(profile?.amenities);
    const condition = (profile?.home_condition ?? profile?.homeCondition ?? "").toString().trim();
    const timeToBuy = (profile?.time_to_buy ?? profile?.timeToBuy ?? "").toString().trim();
    const notes = (profile?.notes ?? "").toString().trim();
    const areas = ""; // not in canonical profile yet
    const dealbreakers = notes ? notes : "";
    const mustHaves = [amenities, condition].filter(Boolean).join(amenities && condition ? " • " : "");
    const timelinePriority = timeToBuy || "";
    return {
      areas,
      propertyType,
      bedsBaths,
      mustHaves,
      timelinePriority,
      dealbreakers
    };
  }
  function paintPreferences(pref){
    setText("bb-pref-areas-v", pref.areas || "—");
    setText("bb-pref-type-v", pref.propertyType || "—");
    setText("bb-pref-beds-v", pref.bedsBaths || "—");
    setText("bb-pref-must-v", pref.mustHaves || "—");
    setText("bb-pref-timeline-v", pref.timelinePriority || "—");
    setText("bb-pref-dealbreakers-v", pref.dealbreakers || "—");
  }
  function paintReadiness(readiness){
    setText("bb-ready-zone-v", readiness.readinessZone || "—");
    setText("bb-ready-financing-v", readiness.financing || "—");
    setText("bb-ready-debt-v", readiness.debt || "—");
    setText("bb-ready-range-v", readiness.range || "—");
    setTextAny(['[data-bb-ready="zone"]'], readiness.readinessZone || "—");
    setTextAny(['[data-bb-ready="financing"]'], readiness.financing || "—");
    setTextAny(['[data-bb-ready="debt"]'], readiness.debt || "—");
    setTextAny(['[data-bb-ready="range"]'], readiness.range || "—");
  }
  // ============================================================
  // 8) Optional tiny “email needed” UI
  // ============================================================
  function ensureEmailPromptUI(){
    const host = document.getElementById("bb-elena-brief-mode");
    if (!host) return null;
    if (host.querySelector("#bb-2cEmailMini")) return host.querySelector("#bb-2cEmailMini");
    const wrap = document.createElement("div");
    wrap.id = "bb-2cEmailMini";
    wrap.style.marginTop = "8px";
    wrap.style.padding = "10px";
    wrap.style.borderRadius = "12px";
    wrap.style.border = "1px solid rgba(255,255,255,.10)";
    wrap.style.background = "rgba(0,0,0,.10)";
    wrap.style.color = "rgba(233,236,255,.82)";
    wrap.style.fontFamily = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
    wrap.style.fontSize = "12px";
    wrap.style.display = "none";
    wrap.innerHTML = `
      <div style="font-weight:900; letter-spacing:.02em; margin-bottom:8px;">Email needed to load your BuyerBrief</div>
      <div style="display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;">
        <input id="bb-2cEmailInput" type="email" placeholder="Email address" autocomplete="email"
          style="width:100%; outline:none; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.18);
                 color:rgba(233,236,255,.92); padding:10px 12px; border-radius:12px; font-weight:800;" />
        <button id="bb-2cEmailSave" type="button"
          style="height:40px; padding:0 14px; border:0; border-radius:12px; cursor:pointer;
                 font-weight:950; letter-spacing:.10em; text-transform:uppercase;
                 background:linear-gradient(180deg, rgba(142,243,197,1), rgba(106,167,255,.95)); color:#06112b;">
          SAVE
        </button>
      </div>
      <div style="margin-top:8px; color:rgba(168,176,214,.85); font-weight:700;">(Used only to pull your profile + preferences.)</div>
    `;
    host.appendChild(wrap);
    const inp = wrap.querySelector("#bb-2cEmailInput");
    const btn = wrap.querySelector("#bb-2cEmailSave");
    if (btn && inp){
      btn.addEventListener("click", () => {
        const ok = setEmail(inp.value);
        if (ok){
          inp.value = "";
          wrap.style.display = "none";
          refreshAll();
        } else {
          btn.textContent = "TRY AGAIN";
          setTimeout(()=> (btn.textContent = "SAVE"), 900);
        }
      });
      inp.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          btn.click();
        }
      });
    }
    return wrap;
  }
  // ============================================================
  // 9) Fetch + paint
  // ============================================================
  const API_BASE = pickApiBase();
  const buyerbrief_id = getBuyerBriefId();
  const CACHE_KEY = `buyerbrief.profile.v1:${buyerbrief_id}`;
  async function loadProfileByEmail(email){
    const em = String(email || "").trim().toLowerCase();
    if (!em || !em.includes("@")) throw new Error("Missing email");
    const urls = [
      `${API_BASE}/profile-by-email`,
      `https://pcsunited.netlify.app/api/profile-by-email`
    ];
    const res = await postWithFallback(urls, { email: em });
    const profile = (res.profile && typeof res.profile === "object") ? res.profile : res;
    if (!profile || typeof profile !== "object") throw new Error("No profile returned");
    return profile;
  }
  function paintFromProfile(profile){
    // ✅ NEW: header update
    paintHeader(profile);
    const verdict = getVerdictPacket();
    const readiness = deriveReadiness(profile, verdict);
    const prefs = derivePreferences(profile);
    paintReadiness(readiness);
    paintPreferences(prefs);
    writeJSON(CACHE_KEY, {
      ts: Date.now(),
      buyerbrief_id,
      email: getEmail(),
      profile,
      readiness,
      preferences: prefs
    });
  }
  async function refreshAll(){
    const email = getEmail();
    const emailPrompt = ensureEmailPromptUI();
    if (!email || !email.includes("@")){
      if (emailPrompt) emailPrompt.style.display = "block";
      return;
    } else {
      if (emailPrompt) emailPrompt.style.display = "none";
    }
    const cached = readJSON(CACHE_KEY);
    if (cached && cached.profile){
      paintFromProfile(cached.profile);
    }
    try{
      const profile = await loadProfileByEmail(email);
      paintFromProfile(profile);
    }catch(e){
      console.warn("[BB 2C] profile-by-email failed:", e);
    }
  }
  // ============================================================
  // 10) Auto-refresh hooks
  // ============================================================
  refreshAll();
  window.addEventListener("pcsunited:unlocked", refreshAll);
  window.addEventListener("pcsunited:loggedout", refreshAll);
  window.addEventListener("storage", (ev) => {
    if (!ev || !ev.key) return;
    const keys = new Set([
      "pcsunited.identity",
      "realtysass.identity",
      "buyerbrief.identity",
      "pcsunited.ec_verdict.v1",
      "realtysass.ec_verdict.v1",
      "realtysass.feasibility.v1"
    ]);
    if (keys.has(ev.key)) refreshAll();
  });
})();
</script>
  </div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=697e270fb126ef5fe6610167" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="../js/webflow.js" type="text/javascript"></script>
</body>
</html>